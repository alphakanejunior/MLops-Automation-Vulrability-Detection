name: Full Project Automatisation de la gestion des vuln√©rabilit√©s dans les pipelines MLops

on:
  push:
    branches:
      - Develop
  pull_request:
    branches:
      - Develop

jobs:
  # =============================================================
  # Job 1 : CodeScan (Bandit)
  # =============================================================
  CodeScan:
    name: Code Security Scan (Bandit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Bandit and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit tabulate

      - name: Run Bandit Scan
        run: |
          mkdir -p "reports/bandit/${{ env.TIMESTAMP }}"
          bandit -r . -f json -o "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json" || echo "‚ö†Ô∏è Bandit found vulnerabilities, workflow continues."
        continue-on-error: true

      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json
          retention-days: 30

  # =============================================================
  # Job 2 : DependencyScan (pip-audit)
  # =============================================================
  DependencyScan:
    name: DependencyScan (pip-audit)
    runs-on: ubuntu-latest
    needs: CodeScan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install project dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pip-audit tabulate

      - name: Run Dependency Scan
        run: |
          mkdir -p "reports/dependency/${{ env.TIMESTAMP }}"
          pip-audit --format=json -o "reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json" || echo "‚ö†Ô∏è Vulnerabilities detected"

      - name: Upload Dependency Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report-${{ env.TIMESTAMP }}
          path: reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json
          retention-days: 30

  # =============================================================
  # Job 3 : ModelScan officiel
  # =============================================================
  ModelScan:
    name: Model Serialization Security Scan
    runs-on: ubuntu-latest
    needs: DependencyScan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Install ModelScan
        run: |
          python -m pip install --upgrade pip
          pip install modelscan==0.8.7

      - name: Create Reports Folder
        run: mkdir -p "reports/models/${{ env.TIMESTAMP }}/official"

      - name: Run ModelScan
        continue-on-error: true
        run: |
          modelscan scan -p model/ --json > "reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json" 2>&1 || true

      - name: Upload ModelScan Report
        uses: actions/upload-artifact@v4
        with:
          name: modelscan-report-${{ env.TIMESTAMP }}
          path: reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json
          retention-days: 30

  # =============================================================
  # Job 4 : ContainerScan (Trivy)
  # =============================================================
  ContainerScan:
    name: ContainerScan (Trivy)
    runs-on: ubuntu-latest
    needs: ModelScan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg

          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb stable main" | sudo tee /etc/apt/sources.list.d/trivy.list

          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Download Trivy DB
        run: trivy image --download-db-only

      # Scan Dockerfiles
      - name: Scan Dockerfiles
        run: |
          REPORT_DIR="reports/container/${TIMESTAMP}/dockerfiles"
          mkdir -p "$REPORT_DIR"
          find . -name 'Dockerfile*' | while read df; do
            SAFE_NAME=$(echo "$df" | tr '/:' '_')
            trivy config --format json -o "${REPORT_DIR}/scan-${SAFE_NAME}.json" "$df" || echo "‚ö†Ô∏è Scan failed for $df"
          done

      # Scan local Docker images
      - name: Scan local Docker images
        shell: bash
        run: |
          set -euo pipefail
          export REPORT_DIR="reports/container/${{ env.TIMESTAMP }}/local-images"
          mkdir -p "$REPORT_DIR"
          docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>" > images.txt || true

          if [ ! -s images.txt ]; then
            echo "‚ö†Ô∏è No Docker images found, skipping local image scan."
          else
            while read -r image; do
              SAFE_NAME=$(echo "$image" | tr '/:' '_')
              OUTPUT_FILE="${REPORT_DIR}/scan-${SAFE_NAME}.json"
              trivy image --format json --ignore-unfixed --vuln-type os,library \
                --severity CRITICAL,HIGH,MEDIUM,LOW -o "$OUTPUT_FILE" "$image" || echo "‚ö†Ô∏è Scan failed for $image"
            done < images.txt
          fi


      # Upload container scan reports
      - name: Upload ContainerScan Reports
        uses: actions/upload-artifact@v4
        with:
          name: container-scan-${{ env.TIMESTAMP }}
          path: reports/container/${{ env.TIMESTAMP }}/
          retention-days: 30

  # =============================================================
  # Job 5 : CVE Enrichment 
  # =============================================================
  CVEEnrichment:
    name: CVE Enrichment from Reports
    runs-on: ubuntu-latest
    needs: [CodeScan, DependencyScan, ModelScan, ContainerScan]  # D√©pend des rapports pr√©c√©dents
    steps:

      # 1Ô∏è‚É£ Checkout du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3Ô∏è‚É£ Installation des d√©pendances Python n√©cessaires
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests tqdm tabulate

      # 4Ô∏è‚É£ Pr√©paration du fichier NVD local
      - name: Prepare local NVD JSON
        run: |
          mkdir -p nvd_db
          # Copier le fichier NVD pr√©-t√©l√©charg√© dans le dossier de travail
          cp nvd_db_prepared/nvdcve-2.0-modified.json nvd_db/
          # V√©rification
          if [[ ! -s nvd_db/nvdcve-2.0-modified.json ]]; then
            echo "‚ùå NVD JSON file missing or empty!"
            exit 1
          fi
          echo "‚úÖ NVD JSON ready:"
          ls -lh nvd_db/nvdcve-2.0-modified.json
          echo "üìÇ First 20 lines for debug:"
          head -n 20 nvd_db/nvdcve-2.0-modified.json

      # 5Ô∏è‚É£ Ex√©cution du script Python pour enrichir les CVE
      - name: Run CVE Enrichment
        run: |
          echo "üîç Enriching CVEs from all reports..."
          python scripts/cve_enrichment.py \
            --nvd-db "nvd_db/nvdcve-2.0-modified.json" \
            --bandit-report "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json" \
            --dependency-report "reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json" \
            --modelscan-report "reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json" \
            --container-reports "reports/container/${{ env.TIMESTAMP }}/**/*.json" \
            --output "reports/cve_enrichment/${{ env.TIMESTAMP }}/enriched_cves.json"

      # 6Ô∏è‚É£ Upload des rapports enrichis comme artefact GitHub
      - name: Upload Enriched CVE Reports
        uses: actions/upload-artifact@v4
        with:
          name: enriched-cve-report-${{ env.TIMESTAMP }}
          path: reports/cve_enrichment/${{ env.TIMESTAMP }}/enriched_cves.json
          retention-days: 30



