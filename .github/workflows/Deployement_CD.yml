# =============================================================
# CD - Secure ML Deployment Pipeline
# =============================================================
# Objectif :
# - Appliquer un Security Gate basÃ© sur les CVE
# - Builder lâ€™image Docker
# - Scanner lâ€™image Docker (Trivy - BLOQUANT)
# - Push dans GHCR
# - DÃ©ployer sur VM via SSH
# - VÃ©rifier la santÃ© de lâ€™application
# ============================================================

name: CD - Secure ML Deployment Pipeline

on:
  workflow_run:
    workflows:
      - Full Project Automatisation de la gestion des vulnÃ©rabilitÃ©s dans les pipelines MLops
    types:
      - completed

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: mlapp
  TIMESTAMP: ${{ github.run_id }}

  # =============================================================
  # Job 1 : Security Gate (CVE enrichies depuis le CI)
  # =============================================================
  
jobs:
  SecurityGate:
    name: Security Gate (CVE Policy)
    runs-on: ubuntu-latest

    # On sâ€™assure que le CI a rÃ©ussi
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - uses: actions/checkout@v4

      # ðŸ”½ TÃ©lÃ©chargement des artifacts DU CI
      - name: Download Enriched CVE Report
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          name: enriched-cve-report-${{ github.event.workflow_run.run_id }}
          path: reports/cve

      - name: Evaluate CVE Policy
        run: |
          python << 'EOF'
          import json, sys

          with open("reports/cve/enriched_cves.json") as f:
              data = json.load(f)

          vulns = data.get("vulnerabilities", [])
          critical = [v for v in vulns if v.get("severity") == "CRITICAL"]

          if critical:
              print("âŒ CRITICAL CVEs detected:")
              for v in critical:
                  print(f"- {v.get('cve')}")
              sys.exit(1)

          print("âœ… CVE gate passed")
          EOF

  # ============================================================
  # Job 2 : Build de lâ€™image Docker (local runner)
  # =============================================================
  BuildImage:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: SecurityGate

    steps:
      - uses: actions/checkout@v4

      # Build local uniquement (pas encore pushÃ©e)
      - name: Build Docker Image
        run: |
          docker build \
            -t ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            .

  # =============================================================
  # Job 3 : Scan de lâ€™image Docker finale (BLOQUANT)
  # =============================================================
  ImageScan:
    name: Trivy Scan - Docker Image
    runs-on: ubuntu-latest
    needs: BuildImage

    steps:
      # Installation manuelle de Trivy (version maÃ®trisÃ©e)
      - name: Install Trivy
        run: |
          TRIVY_VERSION="0.68.1"
          wget -q https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          tar zxvf trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          sudo mv trivy /usr/local/bin/

      # Scan BLOQUANT :
      # - HIGH et CRITICAL
      # - ignore les vulnÃ©rabilitÃ©s non corrigÃ©es
      - name: Scan Docker Image (blocking)
        run: |
          trivy image \
            --exit-code 1 \
            --severity HIGH,CRITICAL \
            --ignore-unfixed \
            ${{ env.IMAGE_NAME }}:${{ github.sha }}

  # =============================================================
  # Job 4 : Push de lâ€™image dans GHCR
  # =============================================================
  PushImage:
    name: Push Docker Image
    runs-on: ubuntu-latest
    needs: ImageScan

    steps:
      - uses: actions/checkout@v4

      # Authentification au registre GHCR
      - name: Login to GHCR
        run: |
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io \
            -u "${{ github.actor }}" \
            --password-stdin

      # Tag + Push uniquement si scan OK
      - name: Tag & Push Image
        run: |
          docker tag ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            ghcr.io/${{ github.repository }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

          docker push ghcr.io/${{ github.repository }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  # =============================================================
  # Job 5 : DÃ©ploiement sur VM (SSH sÃ©curisÃ©)
  # =============================================================
  Deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: PushImage

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            docker pull ghcr.io/${{ github.repository }}/mlapp:${{ github.sha }}

            docker stop mlapp || true
            docker rm mlapp || true

            docker run -d \
              --name mlapp \
              -p 8000:8000 \
              ghcr.io/${{ github.repository }}/mlapp:${{ github.sha }}

  # =============================================================
  # Job 6 : Health Check post-dÃ©ploiement
  # =============================================================
  HealthCheck:
    name: Health Check
    runs-on: ubuntu-latest
    needs: Deploy

    steps:
      # Attente pour laisser lâ€™app dÃ©marrer
      - name: Wait for startup
        run: sleep 15

      # VÃ©rification endpoint /health
      - name: API Health Check
        run: |
          curl -f http://${{ secrets.VM_HOST }}:8000/health
