name: Full Project Automatisation de la gestion des vuln√©rabilit√©s dans les pipelines MLops

# =============================================================
# Triggers du workflow
# =============================================================
on:
  push:
    branches:
      - Develop
  pull_request:
    branches:
      - Develop

# =============================================================
# Variables globales
# =============================================================
env:
  # Identifiant unique pour versionner tous les rapports
  TIMESTAMP: ${{ github.run_id }}

jobs:
  # =============================================================
  # Job 1 : CodeScan
  # Objectif : Analyser les vuln√©rabilit√©s dans le code source
  # Outil    : Bandit (Python SAST)
  # =============================================================
  CodeScan:
    name: Code Security Scan (Bandit)
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # √âtape 1 : R√©cup√©ration du code source
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # √âtape 2 : Configuration de l‚Äôenvironnement Python
      # ---------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ---------------------------------------------------------
      # √âtape 3 : Installation des outils n√©cessaires
      # - Bandit  : scan de s√©curit√© du code
      # - tabulate: affichage structur√© des r√©sultats
      # ---------------------------------------------------------
      - name: Install Bandit and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit tabulate

      # ---------------------------------------------------------
      # √âtape 4 : Ex√©cution du scan Bandit
      # - Scan r√©cursif du projet
      # - G√©n√©ration d‚Äôun rapport JSON versionn√©
      # - Le pipeline continue m√™me si des vuln√©rabilit√©s sont trouv√©es
      # ---------------------------------------------------------
      - name: Run Bandit Scan
        run: |
          REPORT_DIR="reports/bandit/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"
          bandit -r . -f json -o "$REPORT_DIR/bandit-report.json" || true
          echo "‚úÖ Bandit scan finished"

      # ---------------------------------------------------------
      # √âtape 5 : Affichage des r√©sultats Bandit dans la console
      # - Lecture du rapport JSON
      # - Pr√©sentation sous forme de tableau lisible
      # ---------------------------------------------------------
      - name: Display Bandit Scan Results
        run: |
          python - << EOF
          import json
          from tabulate import tabulate

          report_file = "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json"
          with open(report_file) as f:
              data = json.load(f)

          vulns = data.get("results", [])
          if not vulns:
              print("‚úÖ No issues found by Bandit")
          else:
              table = []
              for v in vulns:
                  table.append([
                      v.get("filename"),
                      v.get("line_number"),
                      v.get("issue_severity"),
                      v.get("issue_confidence"),
                      v.get("issue_text")
                  ])
              print("\nüîç Bandit Scan Results:")
              print(tabulate(
                  table,
                  headers=["File", "Line", "Severity", "Confidence", "Issue"],
                  tablefmt="github"
              ))
          EOF

      # ---------------------------------------------------------
      # √âtape 6 : Archivage du rapport Bandit
      # ---------------------------------------------------------
      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json
          retention-days: 30

  # =============================================================
  # Job 2 : DependencyScan
  # Objectif : Analyser les vuln√©rabilit√©s des d√©pendances
  # Outil    : Trivy (filesystem scan)
  # =============================================================
  DependencyScan:
    name: Dependency Vulnerability Scan (Trivy)
    runs-on: ubuntu-latest
    needs: [CodeScan]

    steps:
      # ---------------------------------------------------------
      # √âtape 1 : R√©cup√©ration du code source
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # √âtape 2 : Installation de Trivy
      # ---------------------------------------------------------
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.68.2_Linux-64bit.deb
          sudo dpkg -i trivy_0.68.2_Linux-64bit.deb
          trivy --version

      # ---------------------------------------------------------
      # √âtape 3 : Scan des d√©pendances
      # - Analyse des fichiers requirements / poetry / pipenv
      # - G√©n√©ration d‚Äôun rapport JSON
      # ---------------------------------------------------------
      - name: Run Trivy Dependency Scan
        run: |
          REPORT_DIR="reports/dependency/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"

          trivy fs \
            --scanners vuln \
            --format json \
            --output "$REPORT_DIR/trivy-dependency-report.json" \
            . || true

          echo "‚úÖ Trivy dependency scan finished"

      # ---------------------------------------------------------
      # √âtape 4 : Installation des d√©pendances Python (affichage)
      # ---------------------------------------------------------
      - name: Install Python display dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tabulate

      # ---------------------------------------------------------
      # √âtape 5 : Affichage des r√©sultats Trivy dans la console
      # ---------------------------------------------------------
      - name: Display Dependency Scan Results
        run: |
          python - << 'EOF'
          import json
          from tabulate import tabulate

          report = "reports/dependency/${{ env.TIMESTAMP }}/trivy-dependency-report.json"
          with open(report) as f:
              data = json.load(f)

          rows = []
          for result in data.get("Results", []):
              target = result.get("Target", "")
              for vuln in result.get("Vulnerabilities", []) or []:
                  rows.append([
                      target,
                      vuln.get("PkgName"),
                      vuln.get("InstalledVersion"),
                      vuln.get("VulnerabilityID"),
                      vuln.get("Severity"),
                      vuln.get("Title", "")[:80]
                  ])

          if not rows:
              print("‚úÖ No dependency vulnerabilities found")
          else:
              print("\nüì¶ Dependency Scan Results (Trivy):")
              print(tabulate(
                  rows,
                  headers=["Target", "Package", "Version", "CVE", "Severity", "Description"],
                  tablefmt="github"
              ))
          EOF

      # ---------------------------------------------------------
      # √âtape 6 : Archivage du rapport Trivy
      # ---------------------------------------------------------
      - name: Upload Dependency Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-dependency-report-${{ env.TIMESTAMP }}
          path: reports/dependency/${{ env.TIMESTAMP }}/trivy-dependency-report.json
          retention-days: 30

  # =============================================================
  # Job 4 : ModelScan
  # Objectif : Scanner tous les fichiers mod√®les ML et g√©n√©rer un JSON
  # =============================================================
# =============================================================
# Job 3 : ModelScan officiel (corrig√© et fonctionnel)
# =============================================================
  ModelScan:
    name: Model Serialization Security Scan
    runs-on: ubuntu-latest
    needs: DependencyScan

    steps:
      # ---------------------------------------------------------
      # √âtape 1 : R√©cup√©rer le d√©p√¥t
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # √âtape 2 : Installer ModelScan
      # ---------------------------------------------------------
      - name: Install ModelScan
        run: |
          python -m pip install --upgrade pip
          pip install modelscan==0.8.7

      # ---------------------------------------------------------
      # √âtape 3 : Cr√©er dossier des rapports
      # ---------------------------------------------------------
      - name: Create Reports Folder
        run: mkdir -p "reports/models/${{ env.TIMESTAMP }}/official"

      # ---------------------------------------------------------
      # √âtape 4 : Ex√©cuter ModelScan et convertir TXT -> JSON
      # ---------------------------------------------------------
      - name: Run ModelScan and generate JSON compatible CVEEnrichment
        run: |
          REPORT_TXT="reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.txt"
          REPORT_JSON="reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json"

          mkdir -p "$(dirname "$REPORT_TXT")"

          # Run ModelScan and save TXT
          modelscan scan -p model/model/ | tee "$REPORT_TXT"

          # Export variables pour Python
          export REPORT_TXT
          export REPORT_JSON

          # Convert TXT -> JSON structur√© avec severity
          python - << EOF
          import json
          import os
          import re

          # Fichiers d'entr√©e/sortie
          txt_file = os.environ["REPORT_TXT"]
          json_file = os.environ["REPORT_JSON"]

          vulnerabilities = []
          current_severity = None
          current_description = None
          current_source = None
          inside_issues = False

          with open(txt_file, "r") as f:
              lines = f.readlines()

          for line in lines:
              line = line.strip()

              # D√©but de la vraie section vuln√©rabilit√©s
              if line == "--- Issues by Severity ---":
                  inside_issues = True
                  continue

              # Stop quand on quitte les vuln√©rabilit√©s
              if line.startswith("--- Errors ---") or line.startswith("--- Skipped ---"):
                  break

              if not inside_issues:
                  continue

              # S√©v√©rit√© courante
              sev_match = re.match(r'--- (LOW|MEDIUM|HIGH|CRITICAL) ---', line)
              if sev_match:
                  current_severity = sev_match.group(1)
                  continue

              # Description
              if line.startswith("- Description:"):
                  current_description = line.replace("- Description:", "").strip()
                  continue

              # Source (fichier impact√©)
              if line.startswith("- Source:"):
                  current_source = line.replace("- Source:", "").strip()

                  vulnerabilities.append({
                      "id": f"modelscan-{hash(current_source + current_description)}",
                      "cve": f"modelscan-{hash(current_source + current_description)}",
                      "file": current_source,
                      "description": current_description,
                      "severity": current_severity,
                      "tool": "ModelScan"
                  })

                  # Reset pour la vuln√©rabilit√© suivante
                  current_description = None
                  current_source = None

          # JSON final avec uniquement les vuln√©rabilit√©s r√©elles
          output = {
              "summary": {
                  "total_vulnerabilities": len(vulnerabilities)
              },
              "vulnerabilities": vulnerabilities
          }

          with open(json_file, "w") as f:
              json.dump(output, f, indent=2)

          print(f"‚úÖ ModelScan JSON r√©el g√©n√©r√© : {json_file}")



      # ---------------------------------------------------------
      # √âtape 5 : Upload du rapport JSON
      # ---------------------------------------------------------
      - name: Upload ModelScan Report
        uses: actions/upload-artifact@v4
        with:
          name: modelscan-report-${{ env.TIMESTAMP }}
          path: reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json
          retention-days: 30

# =============================================================
  # Job 4 : ContainerScan (Trivy)
  # =============================================================
  ContainerScan:
    name: ContainerScan (Trivy)
    runs-on: ubuntu-latest
    needs: ModelScan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.68.2_Linux-64bit.deb
          sudo dpkg -i trivy_0.68.2_Linux-64bit.deb
          trivy --version

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Download Trivy DB
        run: trivy image --download-db-only

      - name: Scan Dockerfiles
        run: |
          REPORT_DIR="reports/container/${{ env.TIMESTAMP }}/dockerfiles"
          mkdir -p "$REPORT_DIR"
          find . -name 'Dockerfile*' | while read df; do
            SAFE_NAME=$(echo "$df" | tr '/:' '_')
            trivy config --format json -o "${REPORT_DIR}/scan-${SAFE_NAME}.json" "$df" || echo "‚ö†Ô∏è Scan failed for $df"
          done

      - name: Scan local Docker images
        shell: bash
        run: |
          set -euo pipefail
          export REPORT_DIR="reports/container/${{ env.TIMESTAMP }}/local-images"
          mkdir -p "$REPORT_DIR"
          docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>" > images.txt || true

          if [ ! -s images.txt ]; then
            echo "‚ö†Ô∏è No Docker images found, skipping local image scan."
          else
            while read -r image; do
              SAFE_NAME=$(echo "$image" | tr '/:' '_')
              OUTPUT_FILE="${REPORT_DIR}/scan-${SAFE_NAME}.json"
              trivy image --format json --ignore-unfixed --vuln-type os,library \
                --severity CRITICAL,HIGH,MEDIUM,LOW -o "$OUTPUT_FILE" "$image" || echo "‚ö†Ô∏è Scan failed for $image"
            done < images.txt
          fi

      - name: Upload ContainerScan Reports
        uses: actions/upload-artifact@v4
        with:
          name: container-scan-${{ env.TIMESTAMP }}
          path: reports/container/${{ env.TIMESTAMP }}/
          retention-days: 30

  # =============================================================
  # Job 3 : CVEEnrichment
  # Objectif : Enrichir les vuln√©rabilit√©s du code, d√©pendances et mod√®les
  # Source   : Rapport Bandit + Trivy + ModelScan + Base NVD (JSON)
  # =============================================================
  CVEEnrichment:
    name: Enrichissement CVE complet
    runs-on: ubuntu-latest
    needs:
      - CodeScan
      - DependencyScan
      - ModelScan
      - ContainerScan

    steps:
      # ---------------------------------------------------------
      # √âtape 1 : R√©cup√©ration du d√©p√¥t
      # ---------------------------------------------------------
      - name: R√©cup√©rer le d√©p√¥t
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # √âtape 2 : Configuration de Python
      # ---------------------------------------------------------
      - name: Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ---------------------------------------------------------
      # √âtape 3 : Installation des d√©pendances Python
      # ---------------------------------------------------------
      - name: Installer les d√©pendances Python
        run: |
          python -m pip install --upgrade pip
          pip install requests tqdm tabulate

      # ---------------------------------------------------------
      # √âtape 4 : T√©l√©chargement de la base NVD 2.0 (JSON)
      # ---------------------------------------------------------
      - name: T√©l√©charger la base NVD 2.0 (2020-2025)
        run: |
          mkdir -p nvd_db
          for YEAR in 2020 2021 2022 2023 2024 2025; do
            echo "‚¨áÔ∏è T√©l√©chargement NVD $YEAR..."
            curl -L --retry 5 --retry-delay 10 \
              "https://nvd.nist.gov/feeds/json/cve/2.0/nvdcve-2.0-${YEAR}.json.gz" \
              -o "nvd_db/nvdcve-2.0-${YEAR}.json.gz"
            gunzip -f "nvd_db/nvdcve-2.0-${YEAR}.json.gz"
          done
          echo "‚úÖ NVD 2.0 pr√™te"

      # ---------------------------------------------------------
      # √âtape 5 : T√©l√©charger les rapports Bandit
      # ---------------------------------------------------------
      - name: T√©l√©charger les rapports Bandit
        uses: actions/download-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}

      # ---------------------------------------------------------
      # √âtape 6 : T√©l√©charger le rapport Trivy (d√©pendances)
      # ---------------------------------------------------------
      - name: T√©l√©charger le rapport Trivy
        uses: actions/download-artifact@v4
        with:
          name: trivy-dependency-report-${{ env.TIMESTAMP }}
          path: reports/dependency/${{ env.TIMESTAMP }}

      # ---------------------------------------------------------
      # √âtape 7 : T√©l√©charger le rapport ModelScan
      # ---------------------------------------------------------
      - name: T√©l√©charger le rapport ModelScan
        uses: actions/download-artifact@v4
        with:
          name: modelscan-report-${{ env.TIMESTAMP }}
          path: reports/modelscan/${{ env.TIMESTAMP }}/official

      # ---------------------------------------------------------
      # √âtape 8 : T√©l√©charger le rapport 
      # ---------------------------------------------------------
      - name: T√©l√©charger rapports ContainerScan
        uses: actions/download-artifact@v4
        with:
          name: container-scan-${{ env.TIMESTAMP }}
          path: reports/container/${{ env.TIMESTAMP }}

      # ---------------------------------------------------------
      # √âtape 8 : Enrichissement CVE (Code + D√©pendances + ModelScan)
      # ---------------------------------------------------------
      - name: Enrichissement CVE complet
        run: |
          OUTPUT_DIR="reports/cve_enrichment/${{ env.TIMESTAMP }}"
          mkdir -p "$OUTPUT_DIR"

          python scripts/cve_enrichment.py \
            --nvd-db "nvd_db" \
            --bandit-report "reports/bandit/${{ env.TIMESTAMP }}" \
            --trivy-report "reports/dependency/${{ env.TIMESTAMP }}" \
            --modelscan-report "reports/modelscan/${{ env.TIMESTAMP }}/official" \
            --container-scan-report "reports/container/${{ env.TIMESTAMP }}" \
            --output "$OUTPUT_DIR/enriched_cves.json"

      # ---------------------------------------------------------
      # √âtape 9 : Upload du rapport enrichi
      # ---------------------------------------------------------
      - name: Uploader le rapport CVE enrichi complet
        uses: actions/upload-artifact@v4
        with:
          name: enriched-cve-report-${{ env.TIMESTAMP }}
          path: reports/cve_enrichment/${{ env.TIMESTAMP }}/enriched_cves.json
          retention-days: 30
