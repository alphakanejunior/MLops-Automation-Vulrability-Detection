# =============================================================
# Nom du workflow GitHub Actions
# Ce workflow automatise la d√©tection, l‚Äôenrichissement
# et le reporting des vuln√©rabilit√©s dans un pipeline MLOps
# =============================================================
name: Full Project Automatisation de la gestion des vuln√©rabilit√©s dans les pipelines MLops

# =============================================================
# D√©clencheurs du workflow
# - push sur la branche Develop
# - pull request vers la branche Develop
# =============================================================

on:
  push:
    branches:
      - Develop
      - main
  pull_request:
    branches:
      - Develop
      - main

      
# =============================================================
# Variables d‚Äôenvironnement globales
# =============================================================
env:
  # Identifiant unique bas√© sur l'ex√©cution GitHub
  # Utilis√© pour versionner tous les rapports g√©n√©r√©s
  TIMESTAMP: ${{ github.run_id }}
  IMAGE_NAME: mlapp

jobs:
  # =============================================================
  # Job 1 : CodeScan
  # Objectif :
  # - Analyse de s√©curit√© du code source Python
  # - D√©tection de mauvaises pratiques et failles SAST
  # Outil :
  # - Bandit
  # =============================================================
  CodeScan:
    name: Code Security Scan (Bandit)
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # √âtape 1 : R√©cup√©ration du code source depuis le d√©p√¥t Git
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # √âtape 2 : Installation de Python 3.11
      # ---------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ---------------------------------------------------------
      # √âtape 3 : Installation des outils n√©cessaires
      # - bandit   : analyse de s√©curit√© du code Python
      # - tabulate : affichage lisible des r√©sultats en tableau
      # ---------------------------------------------------------
      - name: Install Bandit and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit tabulate

      # ---------------------------------------------------------
      # √âtape 4 : Ex√©cution du scan Bandit
      # - Analyse r√©cursive du projet
      # - Rapport JSON versionn√©
      # - Le pipeline ne s‚Äôarr√™te pas en cas de vuln√©rabilit√©s
      # ---------------------------------------------------------
      - name: Run Bandit Scan
        run: |
          REPORT_DIR="reports/bandit/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"
          bandit -r . -f json -o "$REPORT_DIR/bandit-report.json" || true
          echo "‚úÖ Bandit scan finished"

      # ---------------------------------------------------------
      # √âtape 5 : Affichage des r√©sultats dans la console
      # - Lecture du rapport JSON
      # - Transformation en tableau lisible (stdout)
      # ---------------------------------------------------------
      - name: Display Bandit Scan Results
        run: |
          python - << EOF
          import json
          from tabulate import tabulate

          report_file = "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json"
          with open(report_file) as f:
              data = json.load(f)

          vulns = data.get("results", [])
          if not vulns:
              print("‚úÖ No issues found by Bandit")
          else:
              table = []
              for v in vulns:
                  table.append([
                      v.get("filename"),
                      v.get("line_number"),
                      v.get("issue_severity"),
                      v.get("issue_confidence"),
                      v.get("issue_text")
                  ])
              print("\nüîç Bandit Scan Results:")
              print(tabulate(
                  table,
                  headers=["File", "Line", "Severity", "Confidence", "Issue"],
                  tablefmt="github"
              ))
          EOF

      # ---------------------------------------------------------
      # √âtape 6 : Archivage du rapport Bandit
      # - Stockage en tant qu‚Äôartifact GitHub
      # ---------------------------------------------------------
      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json
          retention-days: 30

  # =============================================================
  # Job 2 : DependencyScan
  # Objectif :
  # - Analyse des d√©pendances applicatives
  # - D√©tection des CVE connues
  # Outil :
  # - Trivy (filesystem scan)
  # =============================================================
  DependencyScan:
    name: Dependency Vulnerability Scan (Trivy)
    runs-on: ubuntu-latest
    # Ce job ne d√©marre qu'apr√®s la r√©ussite de CodeScan
    needs: [CodeScan]

    steps:
      # ---------------------------------------------------------
      # √âtape 1 : R√©cup√©ration du code source
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # √âtape 2 : Installation de Trivy
      # ---------------------------------------------------------
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.68.2_Linux-64bit.deb
          sudo dpkg -i trivy_0.68.2_Linux-64bit.deb
          trivy --version

      # ---------------------------------------------------------
      # √âtape 3 : Scan des d√©pendances du projet
      # - Analyse automatique des gestionnaires Python
      # - G√©n√©ration d‚Äôun rapport JSON
      # ---------------------------------------------------------
      - name: Run Trivy Dependency Scan
        run: |
          REPORT_DIR="reports/dependency/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"

          trivy fs \
            --scanners vuln \
            --format json \
            --output "$REPORT_DIR/trivy-dependency-report.json" \
            . || true

          echo "‚úÖ Trivy dependency scan finished"

      # ---------------------------------------------------------
      # √âtape 4 : Installation des d√©pendances pour affichage
      # ---------------------------------------------------------
      - name: Install Python display dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tabulate

      # ---------------------------------------------------------
      # √âtape 5 : Affichage des vuln√©rabilit√©s d√©tect√©es
      # ---------------------------------------------------------
      - name: Display Dependency Scan Results
        run: |
          python - << 'EOF'
          import json
          from tabulate import tabulate

          report = "reports/dependency/${{ env.TIMESTAMP }}/trivy-dependency-report.json"
          with open(report) as f:
              data = json.load(f)

          rows = []
          for result in data.get("Results", []):
              target = result.get("Target", "")
              for vuln in result.get("Vulnerabilities", []) or []:
                  rows.append([
                      target,
                      vuln.get("PkgName"),
                      vuln.get("InstalledVersion"),
                      vuln.get("VulnerabilityID"),
                      vuln.get("Severity"),
                      vuln.get("Title", "")[:80]
                  ])

          if not rows:
              print("‚úÖ No dependency vulnerabilities found")
          else:
              print("\nüì¶ Dependency Scan Results (Trivy):")
              print(tabulate(
                  rows,
                  headers=["Target", "Package", "Version", "CVE", "Severity", "Description"],
                  tablefmt="github"
              ))
          EOF

      # ---------------------------------------------------------
      # √âtape 6 : Archivage du rapport Trivy
      # ---------------------------------------------------------
      - name: Upload Dependency Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-dependency-report-${{ env.TIMESTAMP }}
          path: reports/dependency/${{ env.TIMESTAMP }}/trivy-dependency-report.json
          retention-days: 30

  # =============================================================
  # Job 3 : ModelScan
  # Objectif :
  # - Analyser la s√©curit√© des fichiers de mod√®les ML
  # - D√©tecter les risques li√©s √† la d√©s√©rialisation
  # Outil :
  # - ModelScan
  # =============================================================
  ModelScan:
    name: Model Serialization Security Scan
    runs-on: ubuntu-latest
    # Ce job d√©marre apr√®s l‚Äôanalyse des d√©pendances
    needs: DependencyScan

    steps:
      # ---------------------------------------------------------
      # √âtape 1 : R√©cup√©ration du d√©p√¥t Git
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # √âtape 2 : Installation de ModelScan
      # ---------------------------------------------------------
      - name: Install ModelScan
        run: |
          python -m pip install --upgrade pip
          pip install modelscan==0.8.7

      # ---------------------------------------------------------
      # √âtape 3 : Cr√©ation du dossier des rapports ModelScan
      # ---------------------------------------------------------
      - name: Create Reports Folder
        run: mkdir -p "reports/models/${{ env.TIMESTAMP }}/official"

      # ---------------------------------------------------------
      # √âtape 4 : Scan des mod√®les ML
      # - G√©n√©ration d‚Äôun rapport texte natif
      # - Conversion du rapport TXT vers un JSON structur√©
      # ---------------------------------------------------------
      - name: Run ModelScan and generate JSON compatible CVEEnrichment
        run: |
          REPORT_TXT="reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.txt"
          REPORT_JSON="reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json"

          mkdir -p "$(dirname "$REPORT_TXT")"

          # Ex√©cution de ModelScan et sauvegarde du rapport texte
          modelscan scan -p model/model/ | tee "$REPORT_TXT"

          # Export des chemins pour le script Python
          export REPORT_TXT
          export REPORT_JSON

          # Conversion TXT -> JSON structur√©
          python - << EOF
          import json
          import os
          import re

          # Chemins des fichiers
          txt_file = os.environ["REPORT_TXT"]
          json_file = os.environ["REPORT_JSON"]

          vulnerabilities = []
          current_severity = None
          current_description = None
          current_source = None
          inside_issues = False

          # Lecture du fichier texte g√©n√©r√© par ModelScan
          with open(txt_file, "r") as f:
              lines = f.readlines()

          for line in lines:
              line = line.strip()

              # D√©but de la section r√©elle des vuln√©rabilit√©s
              if line == "--- Issues by Severity ---":
                  inside_issues = True
                  continue

              # Fin de la section vuln√©rabilit√©s
              if line.startswith("--- Errors ---") or line.startswith("--- Skipped ---"):
                  break

              if not inside_issues:
                  continue

              # D√©tection de la s√©v√©rit√© courante
              sev_match = re.match(r'--- (LOW|MEDIUM|HIGH|CRITICAL) ---', line)
              if sev_match:
                  current_severity = sev_match.group(1)
                  continue

              # Description de la vuln√©rabilit√©
              if line.startswith("- Description:"):
                  current_description = line.replace("- Description:", "").strip()
                  continue

              # Fichier source impact√©
              if line.startswith("- Source:"):
                  current_source = line.replace("- Source:", "").strip()

                  # Cr√©ation d‚Äôun identifiant unique interne
                  vulnerabilities.append({
                      "id": f"modelscan-{hash(current_source + current_description)}",
                      "cve": f"modelscan-{hash(current_source + current_description)}",
                      "file": current_source,
                      "description": current_description,
                      "severity": current_severity,
                      "tool": "ModelScan"
                  })

                  # R√©initialisation pour la vuln√©rabilit√© suivante
                  current_description = None
                  current_source = None

          # Structure finale du rapport JSON
          output = {
              "summary": {
                  "total_vulnerabilities": len(vulnerabilities)
              },
              "vulnerabilities": vulnerabilities
          }

          with open(json_file, "w") as f:
              json.dump(output, f, indent=2)

          print(f"‚úÖ ModelScan JSON r√©el g√©n√©r√© : {json_file}")

      # ---------------------------------------------------------
      # √âtape 5 : Archivage du rapport ModelScan
      # ---------------------------------------------------------
      - name: Upload ModelScan Report
        uses: actions/upload-artifact@v4
        with:
          name: modelscan-report-${{ env.TIMESTAMP }}
          path: reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json
          retention-days: 30

  # =============================================================
  # Job 4 : ContainerScan
  # Objectif :
  # - Analyser la configuration des conteneurs AVANT le build
  # - Scanner uniquement les Dockerfiles (Infrastructure as Code)
  # - D√©tecter les mauvaises pratiques Docker :
  #   * utilisation de root
  #   * images non pin√©es (latest)
  #   * ports expos√©s inutilement
  #   * secrets hardcod√©s
  #   * permissions dangereuses
  # =============================================================
  ContainerScan:
    name: Container Configuration Scan (Dockerfiles)
    runs-on: ubuntu-latest

    # Ce job ne d√©marre qu'apr√®s la validation des mod√®les ML
    needs: ModelScan

    steps:
      # ---------------------------------------------------------
      # √âtape 1 : R√©cup√©ration du code source
      # - N√©cessaire pour acc√©der aux Dockerfiles
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # √âtape 2 : Installation de Trivy
      # - Trivy est utilis√© ici en mode "config"
      # - Aucun Docker daemon requis
      # ---------------------------------------------------------
      - name: Install Trivy
        run: |
          TRIVY_VERSION="0.68.2"
          wget -q https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.deb
          sudo dpkg -i trivy_${TRIVY_VERSION}_Linux-64bit.deb
          trivy --version


      # ---------------------------------------------------------
      # √âtape 3 : Scan des Dockerfiles (Infrastructure as Code)
      # - Recherche r√©cursive des fichiers Dockerfile*
      # - G√©n√©ration d‚Äôun rapport JSON par Dockerfile
      # - Le pipeline ne s‚Äôarr√™te pas (mode audit / observabilit√©)
      # ---------------------------------------------------------
      - name: Scan Dockerfiles (IaC)
        run: |
          # Dossier de sortie versionn√©
          REPORT_DIR="reports/container/${{ env.TIMESTAMP }}/dockerfiles"
          mkdir -p "$REPORT_DIR"

          # Recherche et scan de chaque Dockerfile
          find . -name 'Dockerfile*' | while read -r dockerfile; do
            SAFE_NAME=$(echo "$dockerfile" | tr '/:' '_')
            echo "üîç Scanning Dockerfile: $dockerfile"

            trivy config \
              --severity CRITICAL,HIGH,MEDIUM,LOW \
              --format json \
              --output "${REPORT_DIR}/scan-${SAFE_NAME}.json" \
              "$dockerfile" || true
          done

          echo "‚úÖ Dockerfile configuration scan completed"

      # ---------------------------------------------------------
      # √âtape 4 bis : Installation des d√©pendances Python
      # Objectif :
      # - Installer les librairies n√©cessaires √† l‚Äôaffichage console
      # - Chaque job GitHub Actions s‚Äôex√©cute dans une VM vierge
      # - Les d√©pendances doivent donc √™tre r√©install√©es ici
      # D√©pendance :
      # - tabulate : affichage lisible des r√©sultats sous forme de tableau
      # ---------------------------------------------------------
      - name: Install Python display dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tabulate
          
      # ---------------------------------------------------------
      # √âtape 5 bis : Affichage console Dockerfile Scan (avec IDs s√©curit√©)
      # - Les r√®gles Trivy sont trait√©es comme des CVE logiques
      # - Compatible avec CVEEnrichment
      # ---------------------------------------------------------
      - name: Display Dockerfile Scan Results (with Security IDs)
        run: |
          python - << 'EOF'
          import json
          import glob
          from tabulate import tabulate

          reports = glob.glob("reports/container/${{ env.TIMESTAMP }}/dockerfiles/*.json")

          rows = []

          for report in reports:
              with open(report) as f:
                  data = json.load(f)

              for result in data.get("Results", []) or []:
                  target = result.get("Target", "")
                  for misconf in result.get("Misconfigurations", []) or []:
                      rows.append([
                          target,
                          misconf.get("ID"),                 # ID Trivy (DSxxx)
                          misconf.get("Severity"),
                          misconf.get("Title"),
                          misconf.get("Message", "")[:80]
                      ])

          if not rows:
              print("‚úÖ No Dockerfile security issues found")
          else:
              print("\nüê≥ Dockerfile Security Issues (Trivy IaC):")
              print(tabulate(
                  rows,
                  headers=[
                      "Dockerfile",
                      "Security ID",
                      "Severity",
                      "Rule",
                      "Details"
                  ],
                  tablefmt="github"
              ))
          EOF

      # ---------------------------------------------------------
      # √âtape 6 : Archivage des rapports ContainerScan
      # - Conservation des r√©sultats pour audit et corr√©lation CVE
      # ---------------------------------------------------------
      - name: Upload Dockerfile Scan Reports
        uses: actions/upload-artifact@v4
        with:
          name: container-dockerfile-scan-${{ env.TIMESTAMP }}
          path: reports/container/${{ env.TIMESTAMP }}/dockerfiles
          retention-days: 30

  # =============================================================
  # Job 5 : CVEEnrichment
  # Objectif :
  # - Corr√©ler toutes les vuln√©rabilit√©s d√©tect√©es
  # - Enrichir via la base officielle NVD (CVE)
  # - G√©n√©rer un rapport unifi√©
  # =============================================================
  CVEEnrichment:
    name: Enrichissement CVE complet
    runs-on: ubuntu-latest
    needs:
      - CodeScan
      - DependencyScan
      - ModelScan
      - ContainerScan

    steps:
      # ---------------------------------------------------------
      # √âtape 1 : R√©cup√©ration du d√©p√¥t
      # ---------------------------------------------------------
      - name: R√©cup√©rer le d√©p√¥t
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # √âtape 2 : Installation de Python
      # ---------------------------------------------------------
      - name: Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ---------------------------------------------------------
      # √âtape 3 : Installation des d√©pendances Python
      # ---------------------------------------------------------
      - name: Installer les d√©pendances Python
        run: |
          python -m pip install --upgrade pip
          pip install requests tqdm tabulate

      # ---------------------------------------------------------
      # √âtape 4 : T√©l√©chargement de la base NVD 2.0
      # ---------------------------------------------------------
      - name: T√©l√©charger la base NVD 2.0 (2020-2025)
        run: |
          mkdir -p nvd_db
          for YEAR in 2020 2021 2022 2023 2024 2025; do
            FILE="nvd_db/nvdcve-2.0-${YEAR}.json.gz"
            echo "‚¨áÔ∏è T√©l√©chargement NVD $YEAR..."

            # Retry jusqu'√† 5 fois avec d√©lai de 10 secondes
            curl -L --retry 5 --retry-delay 10 --retry-max-time 120 \
              "https://nvd.nist.gov/feeds/json/cve/2.0/nvdcve-2.0-${YEAR}.json.gz" \
              -o "$FILE"

            # V√©rifier que le fichier n'est pas vide
            if [ ! -s "$FILE" ]; then
              echo "‚ùå Erreur: le fichier $FILE est vide ou corrompu"
              exit 1
            fi

            gunzip -f "$FILE"
          done
          echo "‚úÖ NVD 2.0 pr√™te"


      # ---------------------------------------------------------
      # √âtapes 5 √† 8 : T√©l√©chargement des rapports de scan
      # ---------------------------------------------------------
      - name: T√©l√©charger les rapports Bandit
        uses: actions/download-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}

      - name: T√©l√©charger le rapport Trivy
        uses: actions/download-artifact@v4
        with:
          name: trivy-dependency-report-${{ env.TIMESTAMP }}
          path: reports/dependency/${{ env.TIMESTAMP }}

      - name: T√©l√©charger le rapport ModelScan
        uses: actions/download-artifact@v4
        with:
          name: modelscan-report-${{ env.TIMESTAMP }}
          path: reports/modelscan/${{ env.TIMESTAMP }}/official

      - name: T√©l√©charger rapports ContainerScan
        uses: actions/download-artifact@v4
        with:
          name: container-dockerfile-scan-${{ env.TIMESTAMP }}
          path: reports/container/${{ env.TIMESTAMP }}

      # ---------------------------------------------------------
      # √âtape 9 : Enrichissement CVE global
      # ---------------------------------------------------------
      - name: Enrichissement CVE complet
        run: |
          OUTPUT_DIR="reports/cve_enrichment/${{ env.TIMESTAMP }}"
          mkdir -p "$OUTPUT_DIR"

          python scripts/cve_enrichment.py \
            --nvd-db "nvd_db" \
            --bandit-report "reports/bandit/${{ env.TIMESTAMP }}" \
            --trivy-report "reports/dependency/${{ env.TIMESTAMP }}" \
            --modelscan-report "reports/modelscan/${{ env.TIMESTAMP }}/official" \
            --container-reports "reports/container/${{ env.TIMESTAMP }}" \
            --output "$OUTPUT_DIR/enriched_cves.json"

      # ---------------------------------------------------------
      # √âtape 10 : Archivage du rapport CVE enrichi final
      # ---------------------------------------------------------
      - name: Uploader le rapport CVE enrichi complet
        uses: actions/upload-artifact@v4
        with:
          name: enriched-cve-report-${{ env.TIMESTAMP }}
          path: reports/cve_enrichment/${{ env.TIMESTAMP }}/enriched_cves.json
          retention-days: 30

  # =============================================================
  # CD Jobs (main only)
  # =============================================================
  SecurityGate:
    name: Security Gate (CVE Policy)
    runs-on: ubuntu-latest
    needs: CVEEnrichment
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: enriched-cve-report-${{ github.run_id }}
          path: reports/cve_enrichment

      - name: Enforce CVE Policy
        run: |
          REPORT=$(find reports/cve_enrichment -name "enriched_cves.json" | head -n 1)
          if [ -z "$REPORT" ]; then
            echo "‚ùå Enriched CVE report not found"
            exit 1
          fi

          python - << 'EOF'
          import json, sys
          with open("reports/cve_enrichment/enriched_cves.json") as f:
              data = json.load(f)

          critical = [
              v for v in data.get("vulnerabilities", [])
              if v.get("severity") == "CRITICAL"
          ]

          if critical:
              print("‚ùå CRITICAL CVEs detected")
              sys.exit(1)

          print("‚úÖ CVE gate passed")
          EOF
  # =============================================================
  # Job 7 : ImageBuild
  # Objectif :
  # - Construire l‚Äôimage Docker de l‚Äôapplication ML
  # - Seulement si la SecurityGate est valid√©e
  # - Image tagg√©e avec le run GitHub (tra√ßabilit√©)
  # =============================================================ImageBuild:
  ImageBuild:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: SecurityGate  # Ne s'ex√©cute que si la SecurityGate est valid√©e
    if: github.ref == 'refs/heads/main'  # Seulement sur la branche main

    steps:
      # ---------------------------------------------------------
      # √âtape 1 : R√©cup√©ration du code source depuis le d√©p√¥t
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # √âtape 2 : Mise en place de Docker Buildx
      # - Permet les builds multi-plateformes et avanc√©s
      # ---------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ---------------------------------------------------------
      # √âtape 3 : Build de l‚Äôimage Docker
      # - Tag versionn√© avec github.run_id pour tra√ßabilit√©
      # ---------------------------------------------------------
      - name: Build Docker image
        run: |
          IMAGE_TAG="${{ env.IMAGE_NAME }}:${{ github.run_id }}"
          echo "üê≥ Building image $IMAGE_TAG"
          docker build -t "$IMAGE_TAG" .
          echo "‚úÖ Docker image built: $IMAGE_TAG"

      # ---------------------------------------------------------
      # √âtape 4 : V√©rification de l‚Äôimage construite
      # ---------------------------------------------------------
      - name: List Docker images
        run: docker images | grep "${{ env.IMAGE_NAME }}"

      # ---------------------------------------------------------
      # √âtape 5 : Sauvegarde de l‚Äôimage Docker en tant qu‚Äôartifact
      # - N√©cessaire pour partager l‚Äôimage entre jobs (Scan/Push)
      # ---------------------------------------------------------
      - name: Save Docker image as artifact
        run: |
          IMAGE_TAG="${{ env.IMAGE_NAME }}:${{ github.run_id }}"
          docker save "$IMAGE_TAG" -o image.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar
          retention-days: 1  # Garder 1 jour, suffisant pour pipeline




# =============================================================
# Job 8 : ImageScan
# Objectif :
# - Scanner l‚Äôimage Docker construite pour vuln√©rabilit√©s
# - Utilisation de Trivy en mode image scan
# - √âchoue si des vuln√©rabilit√©s CRITICAL sont d√©tect√©es
# =============================================================
  ImageScan:
    name: Container Image Vulnerability Scan (Trivy)
    runs-on: ubuntu-latest
    needs: ImageBuild  # N√©cessite l'image construite
    if: github.ref == 'refs/heads/main'

    steps:
      # ---------------------------------------------------------
      # √âtape 1 : Checkout pour coh√©rence du run
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # √âtape 2 : Installation de Trivy (scanner vuln√©rabilit√©s)
      # ---------------------------------------------------------
      - name: Install Trivy
        run: |
          TRIVY_VERSION="0.68.2"
          wget -q https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.deb
          sudo dpkg -i trivy_${TRIVY_VERSION}_Linux-64bit.deb
          trivy --version

      # ---------------------------------------------------------
      # √âtape 3 : T√©l√©charger l‚Äôimage Docker construite
      # ---------------------------------------------------------
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i image.tar

      # ---------------------------------------------------------
      # √âtape 4 : Scan Trivy de l‚Äôimage Docker
      # - D√©tecte les vuln√©rabilit√©s CRITICAL
      # - G√©n√®re un rapport JSON
      # - Sortie avec code 1 si CRITICAL ‚Üí bloque le pipeline
      # ---------------------------------------------------------
      - name: Run Trivy Image Scan
        run: |
          REPORT_DIR="reports/image/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"

          IMAGE_TAG="${{ env.IMAGE_NAME }}:${{ github.run_id }}"
          echo "üîç Scanning image: $IMAGE_TAG"

          trivy image \
            --scanners vuln \
            --severity CRITICAL \
            --exit-code 0 \
            --format json \
            --output "$REPORT_DIR/trivy-image-report.json" \
            "$IMAGE_TAG"

      # Installer Python et tabulate pour affichage console (n√©cessaire)
      - name: Install Python display dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tabulate

      # ---------------------------------------------------------
      # √âtape 5 : Affichage lisible des vuln√©rabilit√©s dans la console
      # ---------------------------------------------------------
      - name: Display Image Scan Results
        run: |
          python - << 'EOF'
          import json
          from tabulate import tabulate

          report = "reports/image/${{ env.TIMESTAMP }}/trivy-image-report.json"
          with open(report) as f:
              data = json.load(f)

          rows = []
          for result in data.get("Results", []) or []:
              target = result.get("Target", "")
              for vuln in result.get("Vulnerabilities", []) or []:
                  rows.append([
                      target,
                      vuln.get("PkgName"),
                      vuln.get("InstalledVersion"),
                      vuln.get("VulnerabilityID"),
                      vuln.get("Severity"),
                      vuln.get("Title", "")[:80]
                  ])

          if not rows:
              print("‚úÖ No image vulnerabilities found")
          else:
              print("\nüõë Container Image Vulnerabilities (Trivy):")
              print(tabulate(
                  rows,
                  headers=["Layer", "Package", "Version", "CVE", "Severity", "Description"],
                  tablefmt="github"
              ))
          EOF

      # ---------------------------------------------------------
      # √âtape 6 : Upload du rapport JSON pour audit et corr√©lation
      # ---------------------------------------------------------
      - name: Upload Image Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report-${{ env.TIMESTAMP }}
          path: reports/image/${{ env.TIMESTAMP }}/trivy-image-report.json
          retention-days: 30

  # =============================================================
  # Job 9 : ImagePush
  # Objectif :
  # - Pousser l‚Äôimage Docker scann√©e vers un registre
  # - Utilisation de GitHub Container Registry (GHCR) 
  # =============================================================
  PushImage:
    name: Push Docker Image to GHCR
    runs-on: ubuntu-latest
    needs: ImageScan
    if: github.ref == 'refs/heads/main'

    steps:
      # ---------------------------------------------------------
      # R√©cup√©ration de l‚Äôimage Docker construite
      # ---------------------------------------------------------
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      # ---------------------------------------------------------
      # Chargement de l‚Äôimage dans Docker
      # ---------------------------------------------------------
      - name: Load Docker image
        run: docker load -i image.tar

      # ---------------------------------------------------------
      # Login GHCR
      # ---------------------------------------------------------
      - name: Login to GHCR
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      # ---------------------------------------------------------
      # Normalisation du nom du repo (lowercase obligatoire)
      # ---------------------------------------------------------
      - name: Set lowercase repository name
        run: |
          echo "REPO_LOWER=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      # ---------------------------------------------------------
      # Tag + Push
      # ---------------------------------------------------------
      - name: Tag and push image
        run: |
          LOCAL_IMAGE="${{ env.IMAGE_NAME }}:${{ github.run_id }}"
          REMOTE_IMAGE="ghcr.io/${REPO_LOWER}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

          echo "üöÄ Pushing $REMOTE_IMAGE"

          docker tag "$LOCAL_IMAGE" "$REMOTE_IMAGE"
          docker push "$REMOTE_IMAGE"
