name: Full Project Automatisation de la gestion des vuln√©rabilit√©s dans les pipelines MLops

# -------------------------------------------------------------
# D√©clencheurs CI
# Le workflow s'ex√©cute automatiquement sur :
#   - chaque push dans la branche develop
#   - chaque pull request ciblant la branche develop
# -------------------------------------------------------------
on:
  push:
    branches:
      - Develop
  pull_request:
    branches:
      - Develop

jobs:
  # =============================================================
  #                        JOB : CodeScan
  # Analyse statique (SAST) du code Python avec Bandit
  # =============================================================
  CodeScan:
    name: Code Security Scan (Bandit)
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # 1. R√©cup√©ration du code source
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 2. G√©n√©ration d'un horodatage unique
      # ---------------------------------------------------------
      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      # ---------------------------------------------------------
      # 3. Configuration de l'environnement Python
      # ---------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ---------------------------------------------------------
      # 4. Installation des d√©pendances Python pour Bandit
      # ---------------------------------------------------------
      - name: Install Bandit and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit tabulate

      # ---------------------------------------------------------
      # 5. Ex√©cution du scan Bandit avec sortie JSON
      # ---------------------------------------------------------
      - name: Run Bandit Scan
        run: |
          echo "üîç Starting Bandit scan..."
          # Cr√©ation du dossier horodat√©
          mkdir -p "reports/bandit/${{ env.TIMESTAMP }}"
          # Scan et export JSON
          bandit -r . -f json -o "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json" || echo "‚ö†Ô∏è Bandit found vulnerabilities, but workflow continues."
        continue-on-error: true

      # ---------------------------------------------------------
      # 6. Upload du rapport JSON comme artefact
      # ---------------------------------------------------------
      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json
          retention-days: 30

      # ---------------------------------------------------------
      # 7. Affichage du rapport sous forme de tableau lisible
      # ---------------------------------------------------------
      - name: Display Bandit Report as Table
        run: |
          python - <<EOF
          import json, os
          from tabulate import tabulate

          report_file = f"reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json"
          if not os.path.exists(report_file):
              print("‚ùå Bandit report not found.")
              exit(1)

          with open(report_file) as f:
              data = json.load(f)

          table = []
          for item in data.get("results", []):
              table.append([
                  item["filename"],
                  item["line_number"],
                  item["issue_severity"],
                  item["issue_confidence"],
                  item["test_name"],
                  item["issue_text"]
              ])

          if table:
              print("\nBandit Security Scan Report:\n")
              print(tabulate(table, headers=["File","Line","Severity","Confidence","Test","Description"], tablefmt="github"))
          else:
              print("‚úÖ No issues found by Bandit.")
          EOF
        shell: bash
        env:
          PYTHONUNBUFFERED: 1
