name: Full Project ‚Äì Automatisation de la gestion des vuln√©rabilit√©s MLOps

# =============================================================
# üîÅ TRIGGERS DU WORKFLOW
# D√©clenchement sur :
#  - push sur la branche Develop
#  - pull request vers Develop
# =============================================================
on:
  push:
    branches: [Develop]
  pull_request:
    branches: [Develop]

# =============================================================
# üåç VARIABLES GLOBALES
# TIMESTAMP permet de versionner tous les rapports
# =============================================================
env:
  TIMESTAMP: ${{ github.run_id }}

jobs:

# =============================================================
# üß© JOB 1 : CodeScan (Bandit)
# Objectif : D√©tecter les vuln√©rabilit√©s dans le code Python
# Outil    : Bandit (SAST)
# =============================================================
  CodeScan:
    name: Code Security Scan (Bandit)
    runs-on: ubuntu-latest

    steps:
      # ------------------------------
      # 1Ô∏è‚É£ R√©cup√©ration du code source
      # ------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------
      # 2Ô∏è‚É£ Setup Python
      # ------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ------------------------------
      # 3Ô∏è‚É£ Installation des outils
      # ------------------------------
      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit tabulate

      # ------------------------------
      # 4Ô∏è‚É£ Scan Bandit
      # ------------------------------
      - name: Run Bandit Scan
        run: |
          REPORT_DIR="reports/bandit/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"
          bandit -r . -f json -o "$REPORT_DIR/bandit-report.json" || true

      # ------------------------------
      # 5Ô∏è‚É£ Affichage console
      # ------------------------------
      - name: Display Bandit Results
        run: |
          python - << EOF
          import json
          from tabulate import tabulate

          path = "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json"
          data = json.load(open(path))
          vulns = data.get("results", [])

          if not vulns:
              print("‚úÖ Aucun probl√®me d√©tect√©")
          else:
              rows = [[
                  v["filename"],
                  v["line_number"],
                  v["issue_severity"],
                  v["issue_confidence"],
                  v["issue_text"]
              ] for v in vulns]

              print(tabulate(
                  rows,
                  headers=["File", "Line", "Severity", "Confidence", "Issue"],
                  tablefmt="github"
              ))
          EOF

      # ------------------------------
      # 6Ô∏è‚É£ Upload artifact
      # ------------------------------
      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json
          retention-days: 30

# =============================================================
# üß© JOB 2 : DependencyScan (Trivy FS)
# Objectif : Scanner les d√©pendances applicatives
# =============================================================
  DependencyScan:
    name: Dependency Scan (Trivy)
    runs-on: ubuntu-latest
    needs: CodeScan

    steps:
      - uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.68.2_Linux-64bit.deb
          sudo dpkg -i trivy_0.68.2_Linux-64bit.deb

      - name: Run Trivy FS Scan
        run: |
          REPORT_DIR="reports/dependency/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"
          trivy fs --format json -o "$REPORT_DIR/trivy-dependency-report.json" . || true

      - name: Upload Dependency Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-dependency-report-${{ env.TIMESTAMP }}
          path: reports/dependency/${{ env.TIMESTAMP }}/trivy-dependency-report.json

# =============================================================
# üß© JOB 3 : ModelScan
# Objectif : D√©tecter les risques li√©s aux mod√®les ML s√©rialis√©s
# =============================================================
  ModelScan:
    name: Model Serialization Security Scan
    runs-on: ubuntu-latest
    needs: DependencyScan

    steps:
      - uses: actions/checkout@v4

      - name: Install ModelScan
        run: |
          pip install modelscan==0.8.7

      - name: Run ModelScan and convert to JSON
        run: |
          REPORT_DIR="reports/modelscan/${{ env.TIMESTAMP }}/official"
          mkdir -p "$REPORT_DIR"

          modelscan scan -p model/model/ | tee "$REPORT_DIR/modelscan.txt"

          python scripts/modelscan_txt_to_json.py \
            "$REPORT_DIR/modelscan.txt" \
            "$REPORT_DIR/modelscan-report.json"

      - name: Upload ModelScan Report
        uses: actions/upload-artifact@v4
        with:
          name: modelscan-report-${{ env.TIMESTAMP }}
          path: reports/modelscan/${{ env.TIMESTAMP }}/official/modelscan-report.json

# =============================================================
# üß© JOB 4 : ContainerScan (Trivy Image)
# Objectif : Scanner les images Docker locales
# =============================================================
  ContainerScan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: ModelScan

    steps:
      - uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.68.2_Linux-64bit.deb
          sudo dpkg -i trivy_0.68.2_Linux-64bit.deb

      - name: Scan Docker Images
        run: |
          REPORT_DIR="reports/container/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"

          docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>" | while read img; do
            SAFE=$(echo "$img" | tr '/:' '_')
            trivy image --format json -o "$REPORT_DIR/$SAFE.json" "$img" || true
          done

      - name: Upload Container Reports
        uses: actions/upload-artifact@v4
        with:
          name: container-scan-${{ env.TIMESTAMP }}
          path: reports/container/${{ env.TIMESTAMP }}

# =============================================================
# üß© JOB 5 : CVE Enrichment (FINAL)
# Objectif : Fusion + enrichissement NVD
# =============================================================
  CVEEnrichment:
    name: Global CVE Enrichment
    runs-on: ubuntu-latest
    needs: [CodeScan, DependencyScan, ModelScan, ContainerScan]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: pip install requests tqdm tabulate

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports

      - name: Run CVE Enrichment
        run: |
          python scripts/cve_enrichment.py \
            --nvd-db nvd_db \
            --bandit-report reports/bandit/${{ env.TIMESTAMP }} \
            --trivy-report reports/dependency/${{ env.TIMESTAMP }} \
            --modelscan-report reports/modelscan/${{ env.TIMESTAMP }}/official \
            --container-reports reports/container/${{ env.TIMESTAMP }} \
            --output reports/cve_enrichment/${{ env.TIMESTAMP }}/enriched_cves.json

      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: enriched-cve-report-${{ env.TIMESTAMP }}
          path: reports/cve_enrichment/${{ env.TIMESTAMP }}/enriched_cves.json
