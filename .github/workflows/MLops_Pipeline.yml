# =============================================================
# Workflow GitHub Actions : CI/CD complet pour MLOps
# Automatisation de la sécurité et déploiement
# =============================================================
name: Full Project Automatisation MLOps

on:
  push:
    branches:
      - Develop
      - main
  pull_request:
    branches:
      - Develop
      - main

env:
  TIMESTAMP: ${{ github.run_id }}
  IMAGE_NAME: mlapp

jobs:
  # =============================================================
  # Job 1 : CodeScan (Bandit)
  # =============================================================
  CodeScan:
    name: Code Security Scan (Bandit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: |
          python -m pip install --upgrade pip
          pip install bandit tabulate
      - run: |
          REPORT_DIR="reports/bandit/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"
          bandit -r . -f json -o "$REPORT_DIR/bandit-report.json" || true
      - run: |
          python - << EOF
          import json
          from tabulate import tabulate
          report_file = "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json"
          with open(report_file) as f:
              data = json.load(f)
          vulns = data.get("results", [])
          if not vulns:
              print("✅ No issues found by Bandit")
          else:
              table = [[v.get("filename"),v.get("line_number"),v.get("issue_severity"),
                        v.get("issue_confidence"),v.get("issue_text")] for v in vulns]
              print(tabulate(table, headers=["File","Line","Severity","Confidence","Issue"], tablefmt="github"))
          EOF
      - uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json
          retention-days: 30

  # =============================================================
  # Job 2 : DependencyScan (Trivy)
  # =============================================================
  DependencyScan:
    name: Dependency Vulnerability Scan (Trivy)
    runs-on: ubuntu-latest
    needs: [CodeScan]
    steps:
      - uses: actions/checkout@v4
      - run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.68.2_Linux-64bit.deb
          sudo dpkg -i trivy_0.68.2_Linux-64bit.deb
          trivy --version
      - run: |
          REPORT_DIR="reports/dependency/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"
          trivy fs --scanners vuln --format json --output "$REPORT_DIR/trivy-dependency-report.json" . || true
      - run: |
          python -m pip install --upgrade pip
          pip install tabulate
      - run: |
          python - << 'EOF'
          import json
          from tabulate import tabulate
          report = "reports/dependency/${{ env.TIMESTAMP }}/trivy-dependency-report.json"
          with open(report) as f:
              data = json.load(f)
          rows = []
          for result in data.get("Results", []):
              target = result.get("Target", "")
              for vuln in result.get("Vulnerabilities", []) or []:
                  rows.append([target, vuln.get("PkgName"), vuln.get("InstalledVersion"),
                               vuln.get("VulnerabilityID"), vuln.get("Severity"), vuln.get("Title","")[:80]])
          if not rows:
              print("✅ No dependency vulnerabilities found")
          else:
              print(tabulate(rows, headers=["Target","Package","Version","CVE","Severity","Description"], tablefmt="github"))
          EOF
      - uses: actions/upload-artifact@v4
        with:
          name: trivy-dependency-report-${{ env.TIMESTAMP }}
          path: reports/dependency/${{ env.TIMESTAMP }}/trivy-dependency-report.json
          retention-days: 30

  # =============================================================
  # Job 3 : ModelScan
  # =============================================================
  ModelScan:
    name: Model Serialization Security Scan
    runs-on: ubuntu-latest
    needs: DependencyScan
    steps:
      - uses: actions/checkout@v4
      - run: |
          python -m pip install --upgrade pip
          pip install modelscan==0.8.7
      - run: mkdir -p "reports/models/${{ env.TIMESTAMP }}/official"
      - run: |
          REPORT_TXT="reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.txt"
          REPORT_JSON="reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json"
          modelscan scan -p model/model/ | tee "$REPORT_TXT"
          export REPORT_TXT REPORT_JSON
          python - << EOF
          import json, os, re
          txt_file = os.environ["REPORT_TXT"]
          json_file = os.environ["REPORT_JSON"]
          vulnerabilities = []
          current_severity = None
          current_description = None
          current_source = None
          inside_issues = False
          with open(txt_file,"r") as f:
              lines = f.readlines()
          for line in lines:
              line=line.strip()
              if line=="--- Issues by Severity ---": inside_issues=True; continue
              if line.startswith("--- Errors ---") or line.startswith("--- Skipped ---"): break
              if not inside_issues: continue
              sev_match = re.match(r'--- (LOW|MEDIUM|HIGH|CRITICAL) ---', line)
              if sev_match: current_severity=sev_match.group(1); continue
              if line.startswith("- Description:"): current_description=line.replace("- Description:","").strip(); continue
              if line.startswith("- Source:"):
                  current_source=line.replace("- Source:","").strip()
                  vulnerabilities.append({"id":f"modelscan-{hash(current_source+current_description)}",
                                          "cve":f"modelscan-{hash(current_source+current_description)}",
                                          "file":current_source,"description":current_description,
                                          "severity":current_severity,"tool":"ModelScan"})
                  current_description=None
                  current_source=None
          output={"summary":{"total_vulnerabilities":len(vulnerabilities)},"vulnerabilities":vulnerabilities}
          with open(json_file,"w") as f: json.dump(output,f,indent=2)
          print(f"✅ ModelScan JSON generated: {json_file}")
          EOF
      - uses: actions/upload-artifact@v4
        with:
          name: modelscan-report-${{ env.TIMESTAMP }}
          path: reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json
          retention-days: 30

  # =============================================================
  # Job 4 : ContainerScan (Dockerfiles)
  # =============================================================
  ContainerScan:
    name: Container Configuration Scan (Dockerfiles)
    runs-on: ubuntu-latest
    needs: ModelScan
    steps:
      - uses: actions/checkout@v4
      - run: |
          TRIVY_VERSION="0.68.2"
          wget -q https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.deb
          sudo dpkg -i trivy_${TRIVY_VERSION}_Linux-64bit.deb
          trivy --version
      - run: |
          REPORT_DIR="reports/container/${{ env.TIMESTAMP }}/dockerfiles"
          mkdir -p "$REPORT_DIR"
          find . -name 'Dockerfile*' | while read -r dockerfile; do
            SAFE_NAME=$(echo "$dockerfile" | tr '/:' '_')
            trivy config --severity CRITICAL,HIGH,MEDIUM,LOW --format json --output "${REPORT_DIR}/scan-${SAFE_NAME}.json" "$dockerfile" || true
          done
      - run: |
          python -m pip install --upgrade pip
          pip install tabulate
      - run: |
          python - << 'EOF'
          import json, glob
          from tabulate import tabulate
          reports = glob.glob("reports/container/${{ env.TIMESTAMP }}/dockerfiles/*.json")
          rows = []
          for report in reports:
              with open(report) as f:
                  data = json.load(f)
              for result in data.get("Results", []) or []:
                  target = result.get("Target","")
                  for misconf in result.get("Misconfigurations",[]) or []:
                      rows.append([target, misconf.get("ID"), misconf.get("Severity"), misconf.get("Title"), misconf.get("Message","")[:80]])
          if not rows: print("✅ No Dockerfile security issues found")
          else: print(tabulate(rows, headers=["Dockerfile","Security ID","Severity","Rule","Details"], tablefmt="github"))
          EOF
      - uses: actions/upload-artifact@v4
        with:
          name: container-dockerfile-scan-${{ env.TIMESTAMP }}
          path: reports/container/${{ env.TIMESTAMP }}/dockerfiles
          retention-days: 30

  # =============================================================
  # Job 5 : CVEEnrichment
  # =============================================================
  CVEEnrichment:
    name: Enrichissement CVE complet
    runs-on: ubuntu-latest
    needs:
      - CodeScan
      - DependencyScan
      - ModelScan
      - ContainerScan
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: |
          python -m pip install --upgrade pip
          pip install requests tqdm tabulate
      - run: |
          mkdir -p nvd_db
          for YEAR in 2020 2021 2022 2023 2024 2025; do
            curl -L --retry 5 --retry-delay 10 "https://nvd.nist.gov/feeds/json/cve/2.0/nvdcve-2.0-${YEAR}.json.gz" -o "nvd_db/nvdcve-2.0-${YEAR}.json.gz"|| true
            gunzip -f "nvd_db/nvdcve-2.0-${YEAR}.json.gz"
          done
      - uses: actions/download-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}
      - uses: actions/download-artifact@v4
        with:
          name: trivy-dependency-report-${{ env.TIMESTAMP }}
          path: reports/dependency/${{ env.TIMESTAMP }}
      - uses: actions/download-artifact@v4
        with:
          name: modelscan-report-${{ env.TIMESTAMP }}
          path: reports/modelscan/${{ env.TIMESTAMP }}/official
      - uses: actions/download-artifact@v4
        with:
          name: container-dockerfile-scan-${{ env.TIMESTAMP }}
          path: reports/container/${{ env.TIMESTAMP }}
      - run: |
          OUTPUT_DIR="reports/cve_enrichment/${{ env.TIMESTAMP }}"
          mkdir -p "$OUTPUT_DIR"
          python scripts/cve_enrichment.py \
            --nvd-db "nvd_db" \
            --bandit-report "reports/bandit/${{ env.TIMESTAMP }}" \
            --trivy-report "reports/dependency/${{ env.TIMESTAMP }}" \
            --modelscan-report "reports/modelscan/${{ env.TIMESTAMP }}/official" \
            --container-reports "reports/container/${{ env.TIMESTAMP }}" \
            --output "$OUTPUT_DIR/enriched_cves.json"
      # ✅ Upload fixe "latest" pour CD
      - uses: actions/upload-artifact@v4
        with:
          name: enriched-cve-report-latest
          path: reports/cve_enrichment/${{ env.TIMESTAMP }}/enriched_cves.json
          retention-days: 30

  # =============================================================
  # CD Jobs (main only)
  # =============================================================
  SecurityGate:
    name: Security Gate (CVE Policy)
    runs-on: ubuntu-latest
    needs: CVEEnrichment
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: enriched-cve-report-latest
          path: reports/cve_enrichment
      - run: |
          REPORT="reports/cve_enrichment/enriched_cves.json"
          if [ ! -f "$REPORT" ]; then
            echo "❌ Enriched CVE report not found"
            exit 1
          fi
          python - << 'EOF'
          import json, sys
          with open("reports/cve_enrichment/enriched_cves.json") as f:
              data=json.load(f)
          critical=[v for v in data.get("vulnerabilities",[]) if v.get("severity")=="CRITICAL"]
          if critical:
              print("❌ CRITICAL CVEs detected")
              sys.exit(1)
          print("✅ CVE gate passed")
          EOF

  BuildImage:
    runs-on: ubuntu-latest
    needs: SecurityGate
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - run: docker build -t ${{ env.IMAGE_NAME }}:${{ github.sha }} .

  ImageScan:
    runs-on: ubuntu-latest
    needs: BuildImage
    if: github.ref == 'refs/heads/main'
    steps:
      - run: |
          TRIVY_VERSION="0.68.2"
          wget -q https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.deb
          sudo dpkg -i trivy_${TRIVY_VERSION}_Linux-64bit.deb
          trivy image --exit-code 1 --severity HIGH,CRITICAL --ignore-unfixed ${{ env.IMAGE_NAME }}:${{ github.sha }}

  PushImage:
    runs-on: ubuntu-latest
    needs: ImageScan
    if: github.ref == 'refs/heads/main'
    steps:
      - run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
      - run: |
          docker tag ${{ env.IMAGE_NAME }}:${{ github.sha }} ghcr.io/${{ github.repository }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ghcr.io/${{ github.repository }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  Deploy:
    runs-on: ubuntu-latest
    needs: PushImage
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            docker pull ghcr.io/${{ github.repository }}/mlapp:${{ github.sha }}
            docker stop mlapp || true
            docker rm mlapp || true
            docker run -d --name mlapp -p 8000:8000 ghcr.io/${{ github.repository }}/mlapp:${{ github.sha }}

  HealthCheck:
    runs-on: ubuntu-latest
    needs: Deploy
    if: github.ref == 'refs/heads/main'
    steps:
      - run: sleep 15
      - run: curl -f http://${{ secrets.VM_HOST }}:8000/health
