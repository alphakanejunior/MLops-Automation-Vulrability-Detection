name: Full Project Automatisation de la gestion des vuln√©rabilit√©s dans les pipelines MLops

# -------------------------------------------------------------
# D√©clencheurs CI
# Le workflow s'ex√©cute automatiquement sur :
#   - chaque push dans la branche develop
#   - chaque pull request ciblant la branche develop
# -------------------------------------------------------------
on:
  push:
    branches:
      - Develop
  pull_request:
    branches:
      - Develop

jobs:
  # =============================================================
  # Job 1 : CodeScan (Bandit)
  # Analyse statique (SAST) du code Python
  # =============================================================
  CodeScan:
    name: Code Security Scan (Bandit)
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ G√©n√©ration d'un horodatage unique
      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      # 3Ô∏è‚É£ Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 4Ô∏è‚É£ Installation des d√©pendances pour Bandit
      - name: Install Bandit and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit tabulate

      # 5Ô∏è‚É£ Scan Bandit et export JSON
      - name: Run Bandit Scan
        run: |
          echo "üîç Starting Bandit scan..."
          mkdir -p "reports/bandit/${{ env.TIMESTAMP }}"
          bandit -r . -f json -o "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json" || echo "‚ö†Ô∏è Bandit found vulnerabilities, but workflow continues."
        continue-on-error: true

      # 6Ô∏è‚É£ Upload du rapport Bandit
      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json
          retention-days: 30

      # 7Ô∏è‚É£ Affichage lisible Bandit
      - name: Display Bandit Report as Table
        run: |
          python - <<EOF
          import json, os
          from tabulate import tabulate

          report_file = f"reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json"
          if not os.path.exists(report_file):
              print("‚ùå Bandit report not found.")
              exit(1)

          with open(report_file) as f:
              data = json.load(f)

          table = []
          for item in data.get("results", []):
              table.append([
                  item["filename"],
                  item["line_number"],
                  item["issue_severity"],
                  item["issue_confidence"],
                  item["test_name"],
                  item["issue_text"]
              ])

          if table:
              print("\nBandit Security Scan Report:\n")
              print(tabulate(table, headers=["File","Line","Severity","Confidence","Test","Description"], tablefmt="grid"))
          else:
              print("‚úÖ No issues found by Bandit.")
          EOF
        shell: bash
        env:
          PYTHONUNBUFFERED: 1

  # =============================================================
  # Job 2 : DependencyScan (pip-audit)
  # Analyse des d√©pendances (SCA)
  # =============================================================
  DependencyScan:
    name: DependencyScan (pip-audit)
    runs-on: ubuntu-latest
    needs: CodeScan

    steps:
      # 1Ô∏è‚É£ Checkout du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ G√©n√©ration d'un horodatage pr√©cis
      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      # 3Ô∏è‚É£ Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 4Ô∏è‚É£ Installation des d√©pendances du projet
      - name: Install project dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # 5Ô∏è‚É£ Installation de pip-audit
      - name: Install pip-audit
        run: pip install pip-audit tabulate

      # 6Ô∏è‚É£ Ex√©cution du scan pip-audit et export JSON
      - name: Run Dependency Scan
        run: |
          echo "üîç Running pip-audit..."
          mkdir -p "reports/dependency/${{ env.TIMESTAMP }}"
          pip-audit --format=json -o "reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json" || echo "‚ö†Ô∏è Vulnerabilities detected"

      # 7Ô∏è‚É£ Upload du rapport JSON comme artefact
      - name: Upload Dependency Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report-${{ env.TIMESTAMP }}
          path: reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json
          retention-days: 30

      # 8Ô∏è‚É£ Affichage lisible du rapport dans la console
      - name: Display Dependency Report
        run: |
          python - <<EOF
          import json, os
          from tabulate import tabulate

          report_file = f"reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json"
          if not os.path.exists(report_file):
              print("‚ùå Dependency report not found.")
              exit(1)

          with open(report_file) as f:
              data = json.load(f)

          table = []

          # Traitement correct du JSON pip-audit
          if isinstance(data, dict) and "dependencies" in data:
              for pkg in data["dependencies"]:
                  vulns = pkg.get("vulns", [])
                  table.append([
                      pkg.get("name", ""),
                      pkg.get("version", ""),
                      ",".join(pkg.get("fix_versions", [])) if pkg.get("fix_versions") else "",
                      ",".join([v.get("id","") for v in vulns]) if vulns else "",
                      ",".join([v.get("description","") for v in vulns]) if vulns else "",
                  ])
          else:
              # Cas fallback si structure JSON inattendue
              table.append([str(data)]*5)

          if table:
              print("\nDependency Security Scan Report:\n")
              print(tabulate(table, headers=["Package","Version","Fixes","CVE","Description"], tablefmt="grid"))
          else:
              print("‚úÖ No vulnerabilities found.")
          EOF
        shell: bash
        env:
          PYTHONUNBUFFERED: 1
          
  # =============================================================
  # Job 3 : ModelScan officiel corrig√©
  # Analyse des mod√®les ML avec ModelScan
  # =============================================================
  # =============================================================
  # Job 3 : ModelScan officiel correctement configur√©
  # =============================================================
  ModelScan:
    name: Model Serialization Security Scan (Official)
    runs-on: ubuntu-latest
    needs: DependencyScan

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Install ModelScan
        run: |
          python -m pip install --upgrade pip
          pip install modelscan==0.8.7

      - name: Create Reports Folder
        run: mkdir -p "reports/models/${{ env.TIMESTAMP }}/official"

      - name: Run ModelScan
        continue-on-error: true
        run: |
          echo "üîç Running ModelScan..."
          modelscan scan -p model/ --json > "reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json" 2>&1 || true

      - name: Upload ModelScan Report
        uses: actions/upload-artifact@v4
        with:
          name: modelscan-report-${{ env.TIMESTAMP }}
          path: reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json
          retention-days: 30

  # ----------------------------
  # Job 4 : Scan des conteneurs Docker
  # ----------------------------
  ContainerScan:
    name: Docker Container Security Scan (Trivy)
    runs-on: ubuntu-latest
    needs: ModelScan    # ou DependencyScan selon ton workflow

    steps:
      # 1Ô∏è‚É£ Checkout du code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ G√©n√©ration d‚Äôun horodatage
      - name: Set Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      # 3Ô∏è‚É£ Installation de tabulate (utilis√© dans le r√©sum√© Python)
      - name: Install tabulate
        run: pip install tabulate

      # 4Ô∏è‚É£ Installation de Trivy
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin v0.57.0

      # 5Ô∏è‚É£ Connexion √† GHCR (si tu veux scanner tes images priv√©es)
      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GHCR_PAT }}" > token.txt
          cat token.txt | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # 6Ô∏è‚É£ Mise √† jour de la base de vuln√©rabilit√©s Trivy
      - name: Download Trivy DB
        run: trivy image --download-db-only

      # 7Ô∏è‚É£ Liste des images Docker locales
      - name: List Docker images
        run: |
          docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>" || true | tee images.txt
          echo "üì¶ Images d√©tect√©es :"
          cat images.txt || echo "(aucune image)"

      # 8Ô∏è‚É£ Gestion du cas o√π il n‚Äôy a AUCUNE image locale
      - name: Check if there are images
        run: |
          if [ ! -s images.txt ]; then
            echo "‚ö†Ô∏è Aucune image Docker locale trouv√©e."
            REPORT_DIR="reports/container/${{ env.TIMESTAMP }}"
            mkdir -p "$REPORT_DIR"
            echo "{}" > "$REPORT_DIR/no-images-found.json"
            exit 0
          fi

      # 9Ô∏è‚É£ Scan avec Trivy et g√©n√©ration des rapports JSON
      - name: Scan Docker images
        run: |
          REPORT_DIR="reports/container/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"
          while read image; do
            IMAGE_SAFE=$(echo $image | tr '/:' '_')
            OUTPUT_FILE="$REPORT_DIR/scan-${IMAGE_SAFE}.json"
            echo "üîç Scanning $image -> $OUTPUT_FILE"
            trivy image \
              --format json \
              --ignore-unfixed \
              --vuln-type os,library \
              --severity CRITICAL,HIGH,MEDIUM,LOW \
              -o "$OUTPUT_FILE" \
              "$image"
          done < images.txt

      # üîü Upload des rapports JSON
      - name: Upload Container Scan Reports
        uses: actions/upload-artifact@v4
        with:
          name: container-scan-${{ env.TIMESTAMP }}
          path: reports/container/${{ env.TIMESTAMP }}/
          retention-days: 30

      # 1Ô∏è‚É£1Ô∏è‚É£ R√©sum√© clair dans la console
      - name: Display Scan Summary
        run: |
          REPORT_DIR="reports/container/${{ env.TIMESTAMP }}"
          python3 - <<EOF
          import os, json, glob
          from tabulate import tabulate

          report_files = glob.glob(os.path.join("${REPORT_DIR}", "*.json"))
          if not report_files:
              print("‚ö†Ô∏è Aucun fichier JSON trouv√© dans", "${REPORT_DIR}")
          else:
              table = []
              for file in report_files:
                  with open(file) as f:
                      data = json.load(f)
                      for result in data.get("Results", []):
                          vulns = result.get("Vulnerabilities") or []
                          table.append([
                              result.get("Target", os.path.basename(file)),
                              len(vulns)
                          ])

              if table:
                  print("\nüõ°Ô∏è Docker Container Scan Summary:\n")
                  print(tabulate(table, headers=["Target Image","Vulnerability Count"], tablefmt="grid"))
              else:
                  print("‚úÖ Aucun probl√®me d√©tect√© dans les images scann√©es.")
          EOF
        shell: bash
        env:
          PYTHONUNBUFFERED: 1
