name: Full Project Automatisation de la gestion des vuln√©rabilit√©s dans les pipelines MLops

on:
  push:
    branches:
      - Develop
  pull_request:
    branches:
      - Develop

env:
  # TIMESTAMP pour versionner les rapports
  TIMESTAMP: ${{ github.run_id }}

jobs:
  # =============================================================
  # Job 1 : CodeScan (Bandit)
  # =============================================================
  CodeScan:
    name: Code Security Scan (Bandit)
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------
      # 1Ô∏è‚É£ Checkout repository
      # R√©cup√®re le code source pour le scanner
      # -----------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------
      # 2Ô∏è‚É£ Setup Python
      # Configure Python 3.11 pour ex√©cuter Bandit et le script d'affichage
      # -----------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -----------------------------------
      # 3Ô∏è‚É£ Install Bandit et tabulate
      # tabulate servira √† afficher les r√©sultats sous forme de tableaux
      # -----------------------------------
      - name: Install Bandit and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit tabulate

      # -----------------------------------
      # 4Ô∏è‚É£ Run Bandit scan
      # Scanne tout le code Python et g√©n√®re un rapport JSON
      # -----------------------------------
      - name: Run Bandit Scan
        run: |
          REPORT_DIR="reports/bandit/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"
          # Ex√©cute Bandit, continue m√™me si vuln√©rabilit√©s trouv√©es
          bandit -r . -f json -o "$REPORT_DIR/bandit-report.json" || true
          echo "‚úÖ Bandit scan finished"

      # -----------------------------------
      # 5Ô∏è‚É£ Display Bandit results in console
      # Affiche les vuln√©rabilit√©s sous forme de tableau lisible
      # -----------------------------------
      - name: Display Bandit Scan Results
        run: |
          python - << EOF
          import json
          from tabulate import tabulate

          report_file = "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json"
          with open(report_file) as f:
              data = json.load(f)

          vulns = data.get("results", [])
          if not vulns:
              print("‚úÖ No issues found by Bandit")
          else:
              table = []
              for v in vulns:
                  table.append([
                      v.get("filename"),
                      v.get("line_number"),
                      v.get("issue_severity"),
                      v.get("issue_confidence"),
                      v.get("issue_text")
                  ])
              print("\nBandit Scan Results:")
              print(tabulate(table, headers=["File", "Line", "Severity", "Confidence", "Issue"], tablefmt="github"))
          EOF

      # -----------------------------------
      # 6Ô∏è‚É£ Upload Bandit Report
      # Stocke le rapport JSON comme artifact pour t√©l√©chargement ult√©rieur
      # -----------------------------------
      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json
          retention-days: 30

  # =============================================================
  # Job : Dependency Scan (Trivy)
  # =============================================================
  DependencyScan:
    name: Dependency Security Scan (Trivy)
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------
      # 1Ô∏è‚É£ Checkout repository
      # -----------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------
      # 2Ô∏è‚É£ Installer Trivy
      # -----------------------------------
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.1_Linux-64bit.deb
          sudo dpkg -i trivy_0.50.1_Linux-64bit.deb

      # -----------------------------------
      # 3Ô∏è‚É£ Scan des d√©pendances (filesystem)
      # -----------------------------------
      - name: Run Trivy Dependency Scan
        run: |
          REPORT_DIR="reports/dependency/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"

          trivy fs . \
            --scanners vuln \
            --format json \
            --output "$REPORT_DIR/dependency-report.json" \
            --severity LOW,MEDIUM,HIGH,CRITICAL \
            --no-progress || true

          echo "‚úÖ Dependency scan finished"

      # -----------------------------------
      # 4Ô∏è‚É£ Affichage console structur√©
      # -----------------------------------
      - name: Display Dependency Scan Results
        run: |
          python - << EOF
          import json
          from tabulate import tabulate

          report = "reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json"

          with open(report) as f:
              data = json.load(f)

          table = []
          for r in data.get("Results", []):
              for v in r.get("Vulnerabilities", []) or []:
                  table.append([
                      v.get("PkgName"),
                      v.get("InstalledVersion"),
                      v.get("VulnerabilityID"),
                      v.get("Severity"),
                      v.get("Title", "")[:80]
                  ])

          if not table:
              print("‚úÖ No dependency vulnerabilities found")
          else:
              print("\nüì¶ Dependency Scan Results:")
              print(tabulate(
                  table,
                  headers=["Package", "Version", "CVE", "Severity", "Description"],
                  tablefmt="github"
              ))
          EOF

      # -----------------------------------
      # 5Ô∏è‚É£ Upload Dependency Report
      # -----------------------------------
      - name: Upload Dependency Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report-${{ env.TIMESTAMP }}
          path: reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json
          retention-days: 30


  # =============================================================
  # Job : Enrichissement CVE pour le code uniquement
  # =============================================================
  CVEEnrichment:
    name: Enrichissement CVE pour le code
    runs-on: ubuntu-latest
    needs: [CodeScan]  # D√©pend uniquement du job CodeScan

    steps:
      # -------------------------------
      # √âtape 1 : R√©cup√©rer le d√©p√¥t
      # On clone le code pour pouvoir acc√©der aux rapports Bandit
      - name: R√©cup√©rer le d√©p√¥t
        uses: actions/checkout@v4

      # -------------------------------
      # √âtape 2 : Configurer Python
      # On installe la version souhait√©e de Python pour ex√©cuter le script
      - name: Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -------------------------------
      # √âtape 3 : Installer les d√©pendances Python
      # requests et tqdm peuvent √™tre utilis√©s pour la NVD ou futurs enrichissements
      # tabulate peut servir √† l'affichage console si n√©cessaire
      - name: Installer les d√©pendances Python
        run: |
          python -m pip install --upgrade pip
          pip install requests tqdm tabulate

      # -------------------------------
      # √âtape 4 : T√©l√©charger la base NVD 2.0 (2020-2025)
      # Cette √©tape pr√©pare la base de donn√©es CVE pour enrichissement futur
      - name: T√©l√©charger la base NVD 2.0 (2020-2025)
        run: |
          mkdir -p nvd_db
          for YEAR in 2020 2021 2022 2023 2024 2025; do
            echo "‚¨áÔ∏è T√©l√©chargement NVD $YEAR..."
            curl -L --retry 5 --retry-delay 10 \
              "https://nvd.nist.gov/feeds/json/cve/2.0/nvdcve-2.0-${YEAR}.json.gz" \
              -o "nvd_db/nvdcve-2.0-${YEAR}.json.gz"
            gunzip -f "nvd_db/nvdcve-2.0-${YEAR}.json.gz"
          done
          echo "‚úÖ NVD 2.0 pr√™te (fichiers s√©par√©s)"

      # -------------------------------
      # √âtape 5 : T√©l√©charger les rapports Bandit
      # On r√©cup√®re les rapports g√©n√©r√©s par le job CodeScan
      - name: T√©l√©charger les rapports Bandit
        uses: actions/download-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}

      # -------------------------------
      # √âtape 7 : Ex√©cuter l'enrichissement CVE pour le code
      # Utilisation du script cve_enrichment.py pour fusionner et enrichir le rapport Bandit
      - name: Ex√©cuter l'enrichissement CVE pour le code
        run: |
          OUTPUT_DIR="reports/cve_enrichment/${{ env.TIMESTAMP }}"
          mkdir -p "$OUTPUT_DIR"

          python scripts/cve_enrichment.py \
            --nvd-db "nvd_db" \
            --bandit-report "reports/bandit/${{ env.TIMESTAMP }}" \
            --output "$OUTPUT_DIR/enriched_code_cves.json"

      # -------------------------------
      # √âtape 8 : Uploader le rapport CVE enrichi (code only)
      # Le rapport JSON final est sauvegard√© comme artifact pour consultation future
      - name: Uploader le rapport CVE enrichi (code only)
        uses: actions/upload-artifact@v4
        with:
          name: enriched-code-cve-report-${{ env.TIMESTAMP }}
          path: reports/cve_enrichment/${{ env.TIMESTAMP }}/enriched_code_cves.json
          retention-days: 30
