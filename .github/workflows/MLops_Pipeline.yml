name: Full Project Automatisation de la gestion des vuln√©rabilit√©s dans les pipelines MLops

on:
  push:
    branches:
      - Develop
  pull_request:
    branches:
      - Develop

# =============================================================
# TIMESTAMP GLOBAL
# =============================================================
env:
  TIMESTAMP: ${{ github.run_id }}

jobs:
  # =============================================================
  # Job 1 : CodeScan (Bandit)
  # =============================================================
  CodeScan:
    name: Code Security Scan (Bandit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Bandit and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit tabulate

      - name: Run Bandit Scan
        run: |
          mkdir -p "reports/bandit/${{ env.TIMESTAMP }}"
          bandit -r . -f json -o "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json" || echo "‚ö†Ô∏è Bandit found vulnerabilities, workflow continues."
        continue-on-error: true

      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json
          retention-days: 30

  # =============================================================
  # Job 2 : DependencyScan (pip-audit)
  # =============================================================
  DependencyScan:
    name: DependencyScan (pip-audit)
    runs-on: ubuntu-latest
    needs: CodeScan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install project dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pip-audit tabulate

# =============================================================
      # =============================================================
      # Install system dependencies (for Pillow and other libs)
      # =============================================================
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libjpeg-dev \
            zlib1g-dev \
            libpng-dev \
            libtiff-dev \
            libfreetype6-dev \
            liblcms2-dev \
            libwebp-dev \
            tcl8.6-dev tk8.6-dev \
            python3-tk

      # =============================================================
      # Install vulnerable Python dependencies (for testing pip-audit)
      # =============================================================
      - name: Install vulnerable dependencies for testing
        run: |
          pip install urllib3==1.25.8
          pip install requests==2.19.1
          pip install PyYAML==5.3
          pip install Jinja2==2.10.0

# =============================================================

      - name: Run Dependency Scan
        run: |
          mkdir -p "reports/dependency/${{ env.TIMESTAMP }}"
          pip-audit --format=json -o "reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json" || echo "‚ö†Ô∏è Vulnerabilities detected"

      - name: Upload Dependency Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report-${{ env.TIMESTAMP }}
          path: reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json
          retention-days: 30

  # =============================================================
  # Job 3 : ModelScan officiel
  # =============================================================
  ModelScan:
    name: Model Serialization Security Scan
    runs-on: ubuntu-latest
    needs: DependencyScan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ModelScan
        run: |
          python -m pip install --upgrade pip
          pip install modelscan==0.8.7

      - name: Create Reports Folder
        run: mkdir -p "reports/models/${{ env.TIMESTAMP }}/official"

      - name: Run ModelScan
        continue-on-error: true
        run: |
          modelscan scan -p model/ --json > "reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json" 2>&1 || true

      - name: Upload ModelScan Report
        uses: actions/upload-artifact@v4
        with:
          name: modelscan-report-${{ env.TIMESTAMP }}
          path: reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json
          retention-days: 30

  # =============================================================
  # Job 4 : ContainerScan (Trivy)
  # =============================================================
  ContainerScan:
    name: ContainerScan (Trivy)
    runs-on: ubuntu-latest
    needs: ModelScan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          TRIVY_VERSION="0.68.1"
          wget -q https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          tar zxvf trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          sudo mv trivy /usr/local/bin/
          trivy --version

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Download Trivy DB
        run: trivy image --download-db-only

      - name: Scan Dockerfiles
        run: |
          REPORT_DIR="reports/container/${{ env.TIMESTAMP }}/dockerfiles"
          mkdir -p "$REPORT_DIR"
          find . -name 'Dockerfile*' | while read df; do
            SAFE_NAME=$(echo "$df" | tr '/:' '_')
            trivy config --format json -o "${REPORT_DIR}/scan-${SAFE_NAME}.json" "$df" || echo "‚ö†Ô∏è Scan failed for $df"
          done

      - name: Scan local Docker images
        shell: bash
        run: |
          set -euo pipefail
          export REPORT_DIR="reports/container/${{ env.TIMESTAMP }}/local-images"
          mkdir -p "$REPORT_DIR"
          docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>" > images.txt || true

          if [ ! -s images.txt ]; then
            echo "‚ö†Ô∏è No Docker images found, skipping local image scan."
          else
            while read -r image; do
              SAFE_NAME=$(echo "$image" | tr '/:' '_')
              OUTPUT_FILE="${REPORT_DIR}/scan-${SAFE_NAME}.json"
              trivy image --format json --ignore-unfixed --vuln-type os,library \
                --severity CRITICAL,HIGH,MEDIUM,LOW -o "$OUTPUT_FILE" "$image" || echo "‚ö†Ô∏è Scan failed for $image"
            done < images.txt
          fi

      - name: Upload ContainerScan Reports
        uses: actions/upload-artifact@v4
        with:
          name: container-scan-${{ env.TIMESTAMP }}
          path: reports/container/${{ env.TIMESTAMP }}/
          retention-days: 30

# =============================================================
# Job 5 : CVE Enrichment
# =============================================================
  CVEEnrichment:
    name: Enrichissement CVE depuis les rapports
    runs-on: ubuntu-latest
    needs: [CodeScan, DependencyScan, ModelScan, ContainerScan]
    steps:
    # -------------------------------
    - name: R√©cup√©rer le d√©p√¥t
      uses: actions/checkout@v4

    # -------------------------------
    - name: Configurer Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # -------------------------------
    - name: Installer les d√©pendances Python
      run: |
        python -m pip install --upgrade pip
        pip install requests tqdm tabulate

    # -------------------------------
    - name: T√©l√©charger et fusionner la base NVD (2020-2025)
      run: |
        sudo apt-get update && sudo apt-get install -y jq
        mkdir -p nvd_db
        for YEAR in 2020 2021 2022 2023 2024 2025; do
          echo "‚¨áÔ∏è T√©l√©chargement NVD $YEAR..."
          curl -L --retry 5 --retry-delay 10 \
            "https://nvd.nist.gov/feeds/json/cve/2.0/nvdcve-2.0-${YEAR}.json.gz" \
            -o "nvd_db/nvdcve-2.0-${YEAR}.json.gz"
          gunzip -f "nvd_db/nvdcve-2.0-${YEAR}.json.gz"
        done
        echo "üîÄ Fusion des fichiers JSON..."
        jq -s '{CVE_Items: map(.CVE_Items) | add}' nvd_db/nvdcve-2.0-*.json > nvd_db/nvdcve-2.0-modified.json
        echo "‚úÖ Base NVD pr√™te"

    # -------------------------------
    - name: V√©rifier la pr√©sence de la base NVD
      run: |
        if [ ! -f "nvd_db/nvdcve-2.0-modified.json" ]; then
          echo "‚ùå Le fichier NVD fusionn√© est manquant !"
          exit 1
        fi
        echo "‚úÖ NVD JSON pr√™t"

    # -------------------------------
    - name: T√©l√©charger les rapports Bandit
      uses: actions/download-artifact@v4
      with:
        name: bandit-report-${{ env.TIMESTAMP }}
        path: reports/bandit/${{ env.TIMESTAMP }}

    - name: T√©l√©charger les rapports de d√©pendances
      uses: actions/download-artifact@v4
      with:
        name: dependency-report-${{ env.TIMESTAMP }}
        path: reports/dependency/${{ env.TIMESTAMP }}

    - name: T√©l√©charger les rapports ModelScan
      uses: actions/download-artifact@v4
      with:
        name: modelscan-report-${{ env.TIMESTAMP }}
        path: reports/models/${{ env.TIMESTAMP }}/official

    - name: T√©l√©charger les rapports ContainerScan
      uses: actions/download-artifact@v4
      with:
        name: container-scan-${{ env.TIMESTAMP }}
        path: reports/container/${{ env.TIMESTAMP }}

    # -------------------------------
    - name: Ex√©cuter l'enrichissement CVE
      run: |
        # R√©cup√©ration des fichiers container JSON sous forme de liste s√©par√©e par des virgules
        CONTAINER_FILES=$(find reports/container/${{ env.TIMESTAMP }}/ -name '*.json' | tr '\n' ',')
        
        # Cr√©er le dossier de sortie
        OUTPUT_DIR="reports/cve_enrichment/${{ env.TIMESTAMP }}"
        mkdir -p "$OUTPUT_DIR"

        # Lancer le script Python
        python scripts/cve_enrichment.py \
          --nvd-db "nvd_db/nvdcve-2.0-modified.json" \
          --bandit-report "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json" \
          --dependency-report "reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json" \
          --modelscan-report "reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json" \
          --container-reports "$CONTAINER_FILES" \
          --output "$OUTPUT_DIR/enriched_cves.json"

    # -------------------------------
    - name: T√©l√©charger le rapport CVE enrichi
      uses: actions/upload-artifact@v4
      with:
        name: enriched-cve-report-${{ env.TIMESTAMP }}
        path: reports/cve_enrichment/${{ env.TIMESTAMP }}/enriched_cves.json
        retention-days: 30
