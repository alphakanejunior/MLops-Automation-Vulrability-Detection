name: Full Project Automatisation de la gestion des vulnérabilités dans les pipelines MLops

on:
  push:
    branches:
      - Develop
  pull_request:
    branches:
      - Develop

# =============================================================
# TIMESTAMP GLOBAL
# =============================================================
env:
  TIMESTAMP: ${{ github.run_id }}

jobs:
  # =============================================================
  # Job 1 : CodeScan (Bandit)
  # =============================================================
  CodeScan:
    name: Code Security Scan (Bandit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Bandit and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit tabulate

      - name: Run Bandit Scan
        run: |
          mkdir -p "reports/bandit/${{ env.TIMESTAMP }}"
          bandit -r . -f json -o "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json" || echo "⚠️ Bandit found vulnerabilities, workflow continues."
        continue-on-error: true

      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json
          retention-days: 30

  # =============================================================
  # Job 2 : DependencyScan (pip-audit)
  # =============================================================
  DependencyScan:
    name: DependencyScan (pip-audit)
    runs-on: ubuntu-latest
    needs: CodeScan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install project dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pip-audit tabulate

# =============================================================
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libjpeg-dev \
            zlib1g-dev \
            libpng-dev \
            libtiff-dev \
            libfreetype6-dev \
            liblcms2-dev \
            libwebp-dev \
            tcl8.6-dev tk8.6-dev \
            python3-tk
# =============================================================

      - name: Run Dependency Scan
        run: |
          mkdir -p "reports/dependency/${{ env.TIMESTAMP }}"
          pip-audit --format=json -o "reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json" || echo "⚠️ Vulnerabilities detected"

      - name: Upload Dependency Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report-${{ env.TIMESTAMP }}
          path: reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json
          retention-days: 30

  # =============================================================
  # Job 3 : ModelScan officiel
  # =============================================================
  ModelScan:
    name: Model Serialization Security Scan
    runs-on: ubuntu-latest
    needs: DependencyScan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ModelScan
        run: |
          python -m pip install --upgrade pip
          pip install modelscan==0.8.7

      - name: Create Reports Folder
        run: mkdir -p "reports/models/${{ env.TIMESTAMP }}/official"

      - name: Run ModelScan
        continue-on-error: true
        run: |
          modelscan scan -p model/ --json > "reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json" 2>&1 || true

      - name: Upload ModelScan Report
        uses: actions/upload-artifact@v4
        with:
          name: modelscan-report-${{ env.TIMESTAMP }}
          path: reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json
          retention-days: 30

  # =============================================================
  # Job 4 : ContainerScan (Trivy)
  # =============================================================
  ContainerScan:
    name: ContainerScan (Trivy)
    runs-on: ubuntu-latest
    needs: ModelScan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          TRIVY_VERSION="0.68.1"
          wget -q https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          tar zxvf trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          sudo mv trivy /usr/local/bin/
          trivy --version

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Download Trivy DB
        run: trivy image --download-db-only

      - name: Scan Dockerfiles
        run: |
          REPORT_DIR="reports/container/${{ env.TIMESTAMP }}/dockerfiles"
          mkdir -p "$REPORT_DIR"
          find . -name 'Dockerfile*' | while read df; do
            SAFE_NAME=$(echo "$df" | tr '/:' '_')
            trivy config --format json -o "${REPORT_DIR}/scan-${SAFE_NAME}.json" "$df" || echo "⚠️ Scan failed for $df"
          done

      - name: Scan local Docker images
        shell: bash
        run: |
          set -euo pipefail
          export REPORT_DIR="reports/container/${{ env.TIMESTAMP }}/local-images"
          mkdir -p "$REPORT_DIR"
          docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>" > images.txt || true

          if [ ! -s images.txt ]; then
            echo "⚠️ No Docker images found, skipping local image scan."
          else
            while read -r image; do
              SAFE_NAME=$(echo "$image" | tr '/:' '_')
              OUTPUT_FILE="${REPORT_DIR}/scan-${SAFE_NAME}.json"
              trivy image --format json --ignore-unfixed --vuln-type os,library \
                --severity CRITICAL,HIGH,MEDIUM,LOW -o "$OUTPUT_FILE" "$image" || echo "⚠️ Scan failed for $image"
            done < images.txt
          fi

      - name: Upload ContainerScan Reports
        uses: actions/upload-artifact@v4
        with:
          name: container-scan-${{ env.TIMESTAMP }}
          path: reports/container/${{ env.TIMESTAMP }}/
          retention-days: 30

  # =============================================================
  # Job 5 : CVE Enrichment
  # =============================================================
  CVEEnrichment:
    name: CVE Enrichment from Reports
    runs-on: ubuntu-latest
    needs: [CodeScan, DependencyScan, ModelScan, ContainerScan]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests tqdm tabulate

      - name: Prepare local NVD JSON
        run: |
          mkdir -p nvd_db
          cp nvd_db_prepared/nvdcve-2.0-modified.json nvd_db/
          if [[ ! -s nvd_db/nvdcve-2.0-modified.json ]]; then
            echo "❌ NVD JSON file missing or empty!"
            exit 1
          fi
          echo "✅ NVD JSON ready"

      - name: Run CVE Enrichment
        run: |
          python scripts/cve_enrichment.py \
            --nvd-db "nvd_db/nvdcve-2.0-modified.json" \
            --bandit-report "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json" \
            --dependency-report "reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json" \
            --modelscan-report "reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json" \
            --container-reports "reports/container/${{ env.TIMESTAMP }}/**/*.json" \
            --output "reports/cve_enrichment/${{ env.TIMESTAMP }}/enriched_cves.json"

      - name: Upload Enriched CVE Reports
        uses: actions/upload-artifact@v4
        with:
          name: enriched-cve-report-${{ env.TIMESTAMP }}
          path: reports/cve_enrichment/${{ env.TIMESTAMP }}/enriched_cves.json
          retention-days: 30
