name: Full Project Automatisation de la gestion des vuln√©rabilit√©s dans les pipelines MLops

# =============================================================
# Triggers du workflow
# =============================================================
on:
  push:
    branches:
      - Develop
  pull_request:
    branches:
      - Develop

# =============================================================
# Variables globales
# =============================================================
env:
  # Identifiant unique pour versionner tous les rapports
  TIMESTAMP: ${{ github.run_id }}

jobs:
  # =============================================================
  # Job 1 : CodeScan
  # Objectif : Analyser les vuln√©rabilit√©s dans le code source
  # Outil    : Bandit (Python SAST)
  # =============================================================
  CodeScan:
    name: Code Security Scan (Bandit)
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # √âtape 1 : R√©cup√©ration du code source
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # √âtape 2 : Configuration de l‚Äôenvironnement Python
      # ---------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ---------------------------------------------------------
      # √âtape 3 : Installation des outils n√©cessaires
      # - Bandit  : scan de s√©curit√© du code
      # - tabulate: affichage structur√© des r√©sultats
      # ---------------------------------------------------------
      - name: Install Bandit and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit tabulate

      # ---------------------------------------------------------
      # √âtape 4 : Ex√©cution du scan Bandit
      # - Scan r√©cursif du projet
      # - G√©n√©ration d‚Äôun rapport JSON versionn√©
      # - Le pipeline continue m√™me si des vuln√©rabilit√©s sont trouv√©es
      # ---------------------------------------------------------
      - name: Run Bandit Scan
        run: |
          REPORT_DIR="reports/bandit/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"
          bandit -r . -f json -o "$REPORT_DIR/bandit-report.json" || true
          echo "‚úÖ Bandit scan finished"

      # ---------------------------------------------------------
      # √âtape 5 : Affichage des r√©sultats Bandit dans la console
      # - Lecture du rapport JSON
      # - Pr√©sentation sous forme de tableau lisible
      # ---------------------------------------------------------
      - name: Display Bandit Scan Results
        run: |
          python - << EOF
          import json
          from tabulate import tabulate

          report_file = "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json"
          with open(report_file) as f:
              data = json.load(f)

          vulns = data.get("results", [])
          if not vulns:
              print("‚úÖ No issues found by Bandit")
          else:
              table = []
              for v in vulns:
                  table.append([
                      v.get("filename"),
                      v.get("line_number"),
                      v.get("issue_severity"),
                      v.get("issue_confidence"),
                      v.get("issue_text")
                  ])
              print("\nüîç Bandit Scan Results:")
              print(tabulate(
                  table,
                  headers=["File", "Line", "Severity", "Confidence", "Issue"],
                  tablefmt="github"
              ))
          EOF

      # ---------------------------------------------------------
      # √âtape 6 : Archivage du rapport Bandit
      # ---------------------------------------------------------
      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json
          retention-days: 30

  # =============================================================
  # Job 2 : DependencyScan
  # Objectif : Analyser les vuln√©rabilit√©s des d√©pendances
  # Outil    : Trivy (filesystem scan)
  # =============================================================
  DependencyScan:
    name: Dependency Vulnerability Scan (Trivy)
    runs-on: ubuntu-latest
    needs: [CodeScan]

    steps:
      # ---------------------------------------------------------
      # √âtape 1 : R√©cup√©ration du code source
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # √âtape 2 : Installation de Trivy
      # ---------------------------------------------------------
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.68.2_Linux-64bit.deb
          sudo dpkg -i trivy_0.68.2_Linux-64bit.deb
          trivy --version

      # ---------------------------------------------------------
      # √âtape 3 : Scan des d√©pendances
      # - Analyse des fichiers requirements / poetry / pipenv
      # - G√©n√©ration d‚Äôun rapport JSON
      # ---------------------------------------------------------
      - name: Run Trivy Dependency Scan
        run: |
          REPORT_DIR="reports/dependency/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"

          trivy fs \
            --scanners vuln \
            --format json \
            --output "$REPORT_DIR/trivy-dependency-report.json" \
            . || true

          echo "‚úÖ Trivy dependency scan finished"

      # ---------------------------------------------------------
      # √âtape 4 : Installation des d√©pendances Python (affichage)
      # ---------------------------------------------------------
      - name: Install Python display dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tabulate

      # ---------------------------------------------------------
      # √âtape 5 : Affichage des r√©sultats Trivy dans la console
      # ---------------------------------------------------------
      - name: Display Dependency Scan Results
        run: |
          python - << 'EOF'
          import json
          from tabulate import tabulate

          report = "reports/dependency/${{ env.TIMESTAMP }}/trivy-dependency-report.json"
          with open(report) as f:
              data = json.load(f)

          rows = []
          for result in data.get("Results", []):
              target = result.get("Target", "")
              for vuln in result.get("Vulnerabilities", []) or []:
                  rows.append([
                      target,
                      vuln.get("PkgName"),
                      vuln.get("InstalledVersion"),
                      vuln.get("VulnerabilityID"),
                      vuln.get("Severity"),
                      vuln.get("Title", "")[:80]
                  ])

          if not rows:
              print("‚úÖ No dependency vulnerabilities found")
          else:
              print("\nüì¶ Dependency Scan Results (Trivy):")
              print(tabulate(
                  rows,
                  headers=["Target", "Package", "Version", "CVE", "Severity", "Description"],
                  tablefmt="github"
              ))
          EOF

      # ---------------------------------------------------------
      # √âtape 6 : Archivage du rapport Trivy
      # ---------------------------------------------------------
      - name: Upload Dependency Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-dependency-report-${{ env.TIMESTAMP }}
          path: reports/dependency/${{ env.TIMESTAMP }}/trivy-dependency-report.json
          retention-days: 30

  # =============================================================
  # Job 4 : ModelScan
  # Objectif : Analyser les mod√®les ML pour vuln√©rabilit√©s et bonnes pratiques
  # Outil    : modelscan
  # =============================================================
  ModelScan:
    name: Scan des mod√®les ML (ModelScan)
    runs-on: ubuntu-latest
    needs: [CodeScan, DependencyScan]

    steps:
      # ---------------------------------------------------------
      # √âtape 1 : R√©cup√©ration du d√©p√¥t
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # √âtape 2 : Installation Python et modelscan
      # ---------------------------------------------------------
      - name: Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Installer ModelScan
        run: |
          python -m pip install --upgrade pip
          pip install modelscan tabulate

      # ---------------------------------------------------------
      # √âtape 3 : Ex√©cution du scan sur tous les mod√®les
      # ---------------------------------------------------------
      - name: Run ModelScan
        run: |
          REPORT_DIR="reports/modelscan/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"

          # On prend tous les fichiers du dossier models/model/
          MODEL_FILES=$(find model/model -type f)

          if [ -z "$MODEL_FILES" ]; then
            echo "‚ö†Ô∏è Aucun mod√®le trouv√© dans models/model/"
          else
            for model_file in $MODEL_FILES; do
              echo "‚¨áÔ∏è Scanning $model_file ..."
              modelscan scan "$model_file" --output "$REPORT_DIR/$(basename $model_file)-report.json" || true
            done
            echo "‚úÖ ModelScan finished"
          fi

      # ---------------------------------------------------------
      # √âtape 4 : Affichage des r√©sultats
      # ---------------------------------------------------------
      - name: Display ModelScan Results
        run: |
          REPORT_DIR="reports/modelscan/${{ env.TIMESTAMP }}"
          REPORT_FILES=$(ls $REPORT_DIR/*-report.json 2>/dev/null || true)

          if [ -z "$REPORT_FILES" ]; then
            echo "‚ö†Ô∏è Aucun rapport ModelScan trouv√©"
          else
            python - << 'EOF'
            import glob, json
            from tabulate import tabulate

            report_files = glob.glob("$REPORT_DIR/*-report.json")
            table = []

            for f in report_files:
                with open(f) as file:
                    data = json.load(file)
                for i in data.get("issues", []):
                    table.append([
                        i.get("name"),
                        i.get("type"),
                        i.get("severity"),
                        i.get("description", "")[:120]
                    ])

            if table:
                print("\nüî¨ ModelScan Results:")
                print(tabulate(
                    table,
                    headers=["Name", "Type", "Severity", "Description"],
                    tablefmt="github"
                ))
            else:
                print("‚úÖ Aucun probl√®me d√©tect√© dans les mod√®les")
            EOF
          fi

      # ---------------------------------------------------------
      # √âtape 5 : Archivage des rapports
      # ---------------------------------------------------------
      - name: Upload ModelScan Report
        uses: actions/upload-artifact@v4
        with:
          name: modelscan-report-${{ env.TIMESTAMP }}
          path: reports/modelscan/${{ env.TIMESTAMP }}/*.json
          retention-days: 30



  # =============================================================
  # Job 3 : CVEEnrichment
  # Objectif : Enrichir les vuln√©rabilit√©s du code avec la base NVD
  # Source   : Rapport Bandit + Base NVD (JSON)
  # =============================================================
  CVEEnrichment:
    name: Enrichissement CVE pour le code
    runs-on: ubuntu-latest
    needs:
    - CodeScan
    - DependencyScan
    - ModelScan

    steps:
      # ---------------------------------------------------------
      # √âtape 1 : R√©cup√©ration du d√©p√¥t
      # ---------------------------------------------------------
      - name: R√©cup√©rer le d√©p√¥t
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # √âtape 2 : Configuration de Python
      # ---------------------------------------------------------
      - name: Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ---------------------------------------------------------
      # √âtape 3 : Installation des d√©pendances Python
      # ---------------------------------------------------------
      - name: Installer les d√©pendances Python
        run: |
          python -m pip install --upgrade pip
          pip install requests tqdm tabulate

      # ---------------------------------------------------------
      # √âtape 4 : T√©l√©chargement de la base NVD 2.0 (JSON)
      # ---------------------------------------------------------
      - name: T√©l√©charger la base NVD 2.0 (2020-2025)
        run: |
          mkdir -p nvd_db
          for YEAR in 2020 2021 2022 2023 2024 2025; do
            echo "‚¨áÔ∏è T√©l√©chargement NVD $YEAR..."
            curl -L --retry 5 --retry-delay 10 \
              "https://nvd.nist.gov/feeds/json/cve/2.0/nvdcve-2.0-${YEAR}.json.gz" \
              -o "nvd_db/nvdcve-2.0-${YEAR}.json.gz"
            gunzip -f "nvd_db/nvdcve-2.0-${YEAR}.json.gz"
          done
          echo "‚úÖ NVD 2.0 pr√™te"

      # ---------------------------------------------------------
      # √âtape 5 : T√©l√©chargement du rapport Bandit
      # ---------------------------------------------------------
      - name: T√©l√©charger les rapports Bandit
        uses: actions/download-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}
      
      # ---------------------------------------------------------
      # T√©l√©charger le rapport Trivy (d√©pendances)
      # ---------------------------------------------------------
      - name: T√©l√©charger le rapport Trivy
        uses: actions/download-artifact@v4
        with:
          name: trivy-dependency-report-${{ env.TIMESTAMP }}
          path: reports/dependency/${{ env.TIMESTAMP }}

      # ---------------------------------------------------------
      # √âtape 6 : Enrichissement CVE (code uniquement)
      # ---------------------------------------------------------
      - name: Enrichissement CVE (code + d√©pendances)
        run: |
          OUTPUT_DIR="reports/cve_enrichment/${{ env.TIMESTAMP }}"
          mkdir -p "$OUTPUT_DIR"

          python scripts/cve_enrichment.py \
            --nvd-db "nvd_db" \
            --bandit-report "reports/bandit/${{ env.TIMESTAMP }}" \
            --trivy-report "reports/dependency/${{ env.TIMESTAMP }}" \
            --output "$OUTPUT_DIR/enriched_cves.json"


      # ---------------------------------------------------------
      # √âtape 7 : Archivage du rapport enrichi
      # ---------------------------------------------------------
      - name: Uploader le rapport CVE enrichi (code only)
        uses: actions/upload-artifact@v4
        with:
          name: enriched-code-cve-report-${{ env.TIMESTAMP }}
          path: reports/cve_enrichment/${{ env.TIMESTAMP }}/enriched_cves.json
          retention-days: 30
