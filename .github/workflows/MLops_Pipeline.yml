name: Full Project Automatisation de la gestion des vulnérabilités dans les pipelines MLops

on:
  push:
    branches:
      - Develop
  pull_request:
    branches:
      - Develop

env:
  # TIMESTAMP pour versionner les rapports
  TIMESTAMP: ${{ github.run_id }}

jobs:
  # =============================================================
  # Job 1 : CodeScan (Bandit)
  # =============================================================
  CodeScan:
    name: Code Security Scan (Bandit)
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------
      # 1️⃣ Checkout repository
      # Récupère le code source pour le scanner
      # -----------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------
      # 2️⃣ Setup Python
      # Configure Python 3.11 pour exécuter Bandit et le script d'affichage
      # -----------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -----------------------------------
      # 3️⃣ Install Bandit et tabulate
      # tabulate servira à afficher les résultats sous forme de tableaux
      # -----------------------------------
      - name: Install Bandit and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit tabulate

      # -----------------------------------
      # 4️⃣ Run Bandit scan
      # Scanne tout le code Python et génère un rapport JSON
      # -----------------------------------
      - name: Run Bandit Scan
        run: |
          REPORT_DIR="reports/bandit/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"
          # Exécute Bandit, continue même si vulnérabilités trouvées
          bandit -r . -f json -o "$REPORT_DIR/bandit-report.json" || true
          echo "✅ Bandit scan finished"

      # -----------------------------------
      # 5️⃣ Display Bandit results in console
      # Affiche les vulnérabilités sous forme de tableau lisible
      # -----------------------------------
      - name: Display Bandit Scan Results
        run: |
          python - << EOF
          import json
          from tabulate import tabulate

          report_file = "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json"
          with open(report_file) as f:
              data = json.load(f)

          vulns = data.get("results", [])
          if not vulns:
              print("✅ No issues found by Bandit")
          else:
              table = []
              for v in vulns:
                  table.append([
                      v.get("filename"),
                      v.get("line_number"),
                      v.get("issue_severity"),
                      v.get("issue_confidence"),
                      v.get("issue_text")
                  ])
              print("\nBandit Scan Results:")
              print(tabulate(table, headers=["File", "Line", "Severity", "Confidence", "Issue"], tablefmt="github"))
          EOF

      # -----------------------------------
      # 6️⃣ Upload Bandit Report
      # Stocke le rapport JSON comme artifact pour téléchargement ultérieur
      # -----------------------------------
      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json
          retention-days: 30

  # =============================================================
  # Job : Enrichissement CVE pour le code uniquement
  # =============================================================
  CVEEnrichment:
    name: Enrichissement CVE pour le code
    runs-on: ubuntu-latest
    needs: [CodeScan]  # Dépend uniquement du job CodeScan

    steps:
      # -------------------------------
      # Étape 1 : Récupérer le dépôt
      # On clone le code pour pouvoir accéder aux rapports Bandit
      - name: Récupérer le dépôt
        uses: actions/checkout@v4

      # -------------------------------
      # Étape 2 : Configurer Python
      # On installe la version souhaitée de Python pour exécuter le script
      - name: Configurer Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -------------------------------
      # Étape 3 : Installer les dépendances Python
      # requests et tqdm peuvent être utilisés pour la NVD ou futurs enrichissements
      # tabulate peut servir à l'affichage console si nécessaire
      - name: Installer les dépendances Python
        run: |
          python -m pip install --upgrade pip
          pip install requests tqdm tabulate

      # -------------------------------
      # Étape 4 : Télécharger la base NVD 2.0 (2020-2025)
      # Cette étape prépare la base de données CVE pour enrichissement futur
      - name: Télécharger la base NVD 2.0 (2020-2025)
        run: |
          mkdir -p nvd_db
          for YEAR in 2020 2021 2022 2023 2024 2025; do
            echo "⬇️ Téléchargement NVD $YEAR..."
            curl -L --retry 5 --retry-delay 10 \
              "https://nvd.nist.gov/feeds/json/cve/2.0/nvdcve-2.0-${YEAR}.json.gz" \
              -o "nvd_db/nvdcve-2.0-${YEAR}.json.gz"
            gunzip -f "nvd_db/nvdcve-2.0-${YEAR}.json.gz"
          done
          echo "✅ NVD 2.0 prête (fichiers séparés)"

      # -------------------------------
      # Étape 5 : Télécharger les rapports Bandit
      # On récupère les rapports générés par le job CodeScan
      - name: Télécharger les rapports Bandit
        uses: actions/download-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}

      # -------------------------------
      # Étape 7 : Exécuter l'enrichissement CVE pour le code
      # Utilisation du script cve_enrichment.py pour fusionner et enrichir le rapport Bandit
      - name: Exécuter l'enrichissement CVE pour le code
        run: |
          OUTPUT_DIR="reports/cve_enrichment/${{ env.TIMESTAMP }}"
          mkdir -p "$OUTPUT_DIR"

          python scripts/cve_enrichment.py \
            --nvd-db "nvd_db" \
            --bandit-report "reports/bandit/${{ env.TIMESTAMP }}" \
            --dependency-report "reports/dependency/${{ env.TIMESTAMP }}" \
            --output "$OUTPUT_DIR/enriched_code_cves.json"

      # -------------------------------
      # Étape 8 : Uploader le rapport CVE enrichi (code only)
      # Le rapport JSON final est sauvegardé comme artifact pour consultation future
      - name: Uploader le rapport CVE enrichi (code only)
        uses: actions/upload-artifact@v4
        with:
          name: enriched-code-cve-report-${{ env.TIMESTAMP }}
          path: reports/cve_enrichment/${{ env.TIMESTAMP }}/enriched_code_cves.json
          retention-days: 30
