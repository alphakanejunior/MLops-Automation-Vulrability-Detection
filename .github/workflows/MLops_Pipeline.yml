name: Full Project Automatisation de la gestion des vulnérabilités dans les pipelines MLops

on:
  push:
    branches:
      - Develop
  pull_request:
    branches:
      - Develop

jobs:
  # =============================================================
  # Job 1 : CodeScan (Bandit)
  # =============================================================
  CodeScan:
    name: Code Security Scan (Bandit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Bandit and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit tabulate

      - name: Run Bandit Scan
        run: |
          mkdir -p "reports/bandit/${{ env.TIMESTAMP }}"
          bandit -r . -f json -o "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json" || echo "⚠️ Bandit found vulnerabilities, workflow continues."
        continue-on-error: true

      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json
          retention-days: 30

  # =============================================================
  # Job 2 : DependencyScan (pip-audit)
  # =============================================================
  DependencyScan:
    name: DependencyScan (pip-audit)
    runs-on: ubuntu-latest
    needs: CodeScan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install project dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pip-audit tabulate

      - name: Run Dependency Scan
        run: |
          mkdir -p "reports/dependency/${{ env.TIMESTAMP }}"
          pip-audit --format=json -o "reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json" || echo "⚠️ Vulnerabilities detected"

      - name: Upload Dependency Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report-${{ env.TIMESTAMP }}
          path: reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json
          retention-days: 30

  # =============================================================
  # Job 3 : ModelScan officiel
  # =============================================================
  ModelScan:
    name: Model Serialization Security Scan
    runs-on: ubuntu-latest
    needs: DependencyScan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Install ModelScan
        run: |
          python -m pip install --upgrade pip
          pip install modelscan==0.8.7

      - name: Create Reports Folder
        run: mkdir -p "reports/models/${{ env.TIMESTAMP }}/official"

      - name: Run ModelScan
        continue-on-error: true
        run: |
          modelscan scan -p model/ --json > "reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json" 2>&1 || true

      - name: Upload ModelScan Report
        uses: actions/upload-artifact@v4
        with:
          name: modelscan-report-${{ env.TIMESTAMP }}
          path: reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json
          retention-days: 30

  # =============================================================
  # Job 4 : ContainerScan (Trivy)
  # =============================================================
  ContainerScan:
    name: ContainerScan (Trivy)
    runs-on: ubuntu-latest
    needs: ModelScan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v0.57.0

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Download Trivy DB
        run: trivy image --download-db-only

      # Scan Dockerfiles
      - name: Scan Dockerfiles
        run: |
          REPORT_DIR="reports/container/${TIMESTAMP}/dockerfiles"
          mkdir -p "$REPORT_DIR"
          find . -name 'Dockerfile*' | while read df; do
            SAFE_NAME=$(echo "$df" | tr '/:' '_')
            trivy config --format json -o "${REPORT_DIR}/scan-${SAFE_NAME}.json" "$df" || echo "⚠️ Scan failed for $df"
          done

      # Scan local Docker images
      - name: Scan local Docker images
        shell: bash
        run: |
          set -euo pipefail
          export REPORT_DIR="reports/container/${{ env.TIMESTAMP }}/local-images"
          mkdir -p "$REPORT_DIR"
          docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>" > images.txt || true

          if [ ! -s images.txt ]; then
            echo "⚠️ No Docker images found, skipping local image scan."
          else
            while read -r image; do
              SAFE_NAME=$(echo "$image" | tr '/:' '_')
              OUTPUT_FILE="${REPORT_DIR}/scan-${SAFE_NAME}.json"
              trivy image --format json --ignore-unfixed --vuln-type os,library \
                --severity CRITICAL,HIGH,MEDIUM,LOW -o "$OUTPUT_FILE" "$image" || echo "⚠️ Scan failed for $image"
            done < images.txt
          fi


      # Upload container scan reports
      - name: Upload ContainerScan Reports
        uses: actions/upload-artifact@v4
        with:
          name: container-scan-${{ env.TIMESTAMP }}
          path: reports/container/${{ env.TIMESTAMP }}/
          retention-days: 30

  # =============================================================
  # Job 5 : CVE Enrichment (Objectif 4)
  # =============================================================
  CVEEnrichment:
    name: CVE Enrichment
    runs-on: ubuntu-latest
    needs: [CodeScan, DependencyScan, ModelScan, ContainerScan]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download all scan artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports/all

      - name: Download NVD JSON dump
        run: |
          mkdir -p nvd_db
          cd nvd_db
          if [ ! -f nvdcve-1.1-2025.json.gz ]; then
            curl -L -O https://nvd.nist.gov/feeds/json/cve/1.1/nvdcve-1.1-2025.json.gz
          fi
          gzip -dk nvdcve-1.1-2025.json.gz

      - name: Run CVE Enrichment Script
        run: python scripts/cve_enrichment.py

      - name: Upload CVE Enriched Report
        uses: actions/upload-artifact@v4
        with:
          name: cve-enriched-report
          path: reports/cve_enriched/cve-report.json
          retention-days: 30
