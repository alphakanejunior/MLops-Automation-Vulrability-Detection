name: Full Project Automatisation de la gestion des vuln√©rabilit√©s dans les pipelines MLops.

# -------------------------------------------------------------
# D√©clencheurs CI
# Le workflow s'ex√©cute automatiquement sur :
#   - chaque push dans la branche develop
#   - chaque pull request ciblant la branche develop
# -------------------------------------------------------------
on:
  push:
    branches:
      - Develop
  pull_request:
    branches:
      - Develop

jobs:
  # =============================================================
  #                        JOB : CodeScan
  # Analyse statique (SAST) du code Python avec Bandit
  # =============================================================
  CodeScan:
    name: Code Security Scan (Bandit)
    runs-on: ubuntu-latest   # Machine Linux fournie par GitHub

    steps:

      # ---------------------------------------------------------
      # 1. R√©cup√©ration du code source du d√©p√¥t
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 2. G√©n√©ration d'un horodatage unique
      #    Utilis√© pour nommer les dossiers et rapports afin
      #    d'√©viter toute collision entre diff√©rentes ex√©cutions.
      #    Format : YYYY-MM-DD_HH-MM-SS
      # ---------------------------------------------------------
      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      # ---------------------------------------------------------
      # 3. Configuration de l'environnement Python
      #    Installation d'une version stable et support√©e
      # ---------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ---------------------------------------------------------
      # 4. Installation de Bandit (outil SAST pour Python)
      #    Mise √† jour de pip + installation du scanner.
      # ---------------------------------------------------------
      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit

      # ---------------------------------------------------------
      # 5. Ex√©cution du scan Bandit
      #    - Cr√©ation d'un dossier unique bas√© sur l'horodatage
      #    - Export du rapport JSON dans ce dossier
      #
      #    Exemple final :
      #    reports/bandit/2025-02-01_14-23-58/bandit-report.json
      # ---------------------------------------------------------
      - name: Run Bandit Scan
        run: |
            echo "üîç Starting Bandit scan..."
            # Cr√©ation du dossier horodat√© pour stocker le rapport
            mkdir -p "reports/bandit/${{ env.TIMESTAMP }}"
            # Ex√©cution de Bandit avec sortie JSON
            bandit -r . -f json -o "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json" || echo "‚ö†Ô∏è Bandit found vulnerabilities, but workflow continues."
        continue-on-error: true

      # ---------------------------------------------------------
      # 6. Upload du rapport comme artefact
      #    (Bonne pratique CI/CD : pas de commit dans le repo)
      #
      #    L'artefact sera nomm√© :
      #       bandit-report-YYYY-MM-DD_HH-MM-SS
      #
      #    et t√©l√©chargeable dans l'UI GitHub Actions.
      # ---------------------------------------------------------
      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json
          retention-days: 30  # Dur√©e de r√©tention configurable


    # ==============================================================================

