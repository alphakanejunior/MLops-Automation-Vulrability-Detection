# =============================================================
# CD - Secure ML Deployment Pipeline
# =============================================================
# Objectif :
# - Appliquer un Security Gate bas√© sur les CVE
# - Builder l‚Äôimage Docker
# - Scanner l‚Äôimage Docker (Trivy - BLOQUANT)
# - Push dans GHCR
# - D√©ployer sur VM via SSH
# - V√©rifier la sant√© de l‚Äôapplication
# ============================================================

name: CD - Secure ML Deployment Pipeline

on:
  workflow_run:
    workflows:
      - Full Project Automatisation de la gestion des vuln√©rabilit√©s dans les pipelines MLops
    types:
      - completed
      
# ‚ö†Ô∏è OBLIGATOIRE pour lire les artifacts du CI
permissions:
  actions: read
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: mlapp
  TIMESTAMP: ${{ github.run_id }}
  # SHA du commit CI pour tag Docker
  CI_SHA: ${{ github.event.workflow_run.head_sha }}

jobs:
  # =============================================================
  # Job 1 : Security Gate (CVE enrichies depuis le CI)
  # =============================================================
  SecurityGate:
    name: Security Gate (CVE Policy)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - uses: actions/checkout@v4

      # üîΩ T√©l√©chargement des artifacts DU CI
      - name: Download CI Artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          path: artifacts

      - name: Evaluate CVE Policy
        run: |
          python << 'EOF'
          import json, glob, sys

          files = glob.glob("artifacts/enriched-cve-report-*/enriched_cves.json")

          if not files:
              print("‚ùå Enriched CVE report not found")
              sys.exit(1)

          report = files[0]
          print(f"üìÑ Using CVE report: {report}")

          with open(report) as f:
              data = json.load(f)

          vulns = data.get("vulnerabilities", [])
          critical = [v for v in vulns if v.get("severity") == "CRITICAL"]

          if critical:
              print("‚ùå CRITICAL CVEs detected:")
              for v in critical:
                  print(f"- {v.get('cve')}")
              sys.exit(1)

          print("‚úÖ CVE gate passed")
          EOF

  # =============================================================
  # Job 2 : Build Docker Image
  # =============================================================
  BuildImage:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: SecurityGate

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          docker build \
            -t ${{ env.IMAGE_NAME }}:${{ env.CI_SHA }} \
            .

  # =============================================================
  # Job 3 : Scan Docker Image (BLOQUANT)
  # =============================================================
  ImageScan:
    name: Trivy Scan - Docker Image
    runs-on: ubuntu-latest
    needs: BuildImage

    steps:
      - name: Install Trivy
        run: |
          TRIVY_VERSION="0.68.2"
          wget -q https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.deb
          sudo dpkg -i trivy_${TRIVY_VERSION}_Linux-64bit.deb
          trivy --version

      - name: Scan Docker Image (blocking)
        run: |
          trivy image \
            --exit-code 1 \
            --severity HIGH,CRITICAL \
            --ignore-unfixed \
            ${{ env.IMAGE_NAME }}:${{ env.CI_SHA }}

  # =============================================================
  # Job 4 : Push Docker Image
  # =============================================================
  PushImage:
    name: Push Docker Image
    runs-on: ubuntu-latest
    needs: ImageScan

    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io \
            -u "${{ github.actor }}" \
            --password-stdin

      - name: Tag & Push Image
        run: |
          docker tag ${{ env.IMAGE_NAME }}:${{ env.CI_SHA }} \
            ghcr.io/${{ github.repository }}/${{ env.IMAGE_NAME }}:${{ env.CI_SHA }}

          docker push ghcr.io/${{ github.repository }}/${{ env.IMAGE_NAME }}:${{ env.CI_SHA }}

  # =============================================================
  # Job 5 : D√©ploiement sur VM
  # =============================================================
  Deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: PushImage

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            docker pull ghcr.io/${{ github.repository }}/mlapp:${{ env.CI_SHA }}

            docker stop mlapp || true
            docker rm mlapp || true

            docker run -d \
              --name mlapp \
              -p 8000:8000 \
              ghcr.io/${{ github.repository }}/mlapp:${{ env.CI_SHA }}

  # =============================================================
  # Job 6 : Health Check
  # =============================================================
  HealthCheck:
    name: Health Check
    runs-on: ubuntu-latest
    needs: Deploy

    steps:
      - name: Wait for startup
        run: sleep 15

      - name: API Health Check
        run: |
          curl -f http://${{ secrets.VM_HOST }}:8000/health
