name: CD - Secure ML Deployment Pipeline

on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: mlapp
  TIMESTAMP: ${{ github.run_id }}

jobs:
  # =============================================================
  # Job 1 : Security Gate (rapport CVE enrichi)
  # =============================================================
  SecurityGate:
    name: Security Gate (CVE Policy)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download Enriched CVE Report
        uses: actions/download-artifact@v4
        with:
          name: enriched-cve-report-${{ env.TIMESTAMP }}
          path: reports/cve

      - name: Evaluate CVE Policy
        run: |
          python << 'EOF'
          import json, sys
          data = json.load(open("reports/cve/enriched_cves.json"))
          vulns = data.get("vulnerabilities", [])
          critical = [v for v in vulns if v.get("severity") == "CRITICAL"]
          if critical:
              print("❌ CRITICAL CVEs detected:")
              for v in critical:
                  print(v.get("cve_id"))
              sys.exit(1)
          print("✅ CVE gate passed")
          EOF

  # =============================================================
  # Job 2 : Build Docker Image (local uniquement)
  # =============================================================
  BuildImage:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: SecurityGate

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          docker build \
            -t ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            .

  # =============================================================
  # Job 3 : Scan image Docker finale avec Trivy (BLOQUANT)
  # =============================================================
  ImageScan:
    name: Trivy Scan - Final Docker Image
    runs-on: ubuntu-latest
    needs: BuildImage

    steps:
      - name: Install Trivy
        run: |
          TRIVY_VERSION="0.68.1"
          wget -q https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          tar zxvf trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          sudo mv trivy /usr/local/bin/

      - name: Scan Docker Image (blocking)
        run: |
          trivy image \
            --exit-code 1 \
            --severity CRITICAL,HIGH \
            --ignore-unfixed \
            ${{ env.IMAGE_NAME }}:${{ github.sha }}

  # =============================================================
  # Job 4 : Tag & Push image (uniquement si scan OK)
  # =============================================================
  PushImage:
    name: Push Docker Image
    runs-on: ubuntu-latest
    needs: ImageScan

    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io \
            -u "${{ github.actor }}" --password-stdin

      - name: Tag & Push
        run: |
          docker tag ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            ghcr.io/${{ github.repository }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

          docker push ghcr.io/${{ github.repository }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  # =============================================================
  # Job 5 : Déploiement
  # =============================================================
  Deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: PushImage

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            docker pull ghcr.io/${{ github.repository }}/mlapp:${{ github.sha }}
            docker stop mlapp || true
            docker rm mlapp || true
            docker run -d \
              --name mlapp \
              -p 8000:8000 \
              ghcr.io/${{ github.repository }}/mlapp:${{ github.sha }}

  # =============================================================
  # Job 6 : Health Check post-déploiement
  # =============================================================
  HealthCheck:
    name: Health Check
    runs-on: ubuntu-latest
    needs: Deploy

    steps:
      - run: sleep 15

      - name: API health
        run: |
          curl -f http://${{ secrets.DEPLOY_HOST }}:8000/health
