name: Full Project Automatisation de la gestion des vulnérabilités dans les pipelines MLops

on:
  push:
    branches:
      - Develop
  pull_request:
    branches:
      - Develop

env:
  # TIMESTAMP pour versionner les rapports
  TIMESTAMP: ${{ github.run_id }}

jobs:
  # =============================================================
  # Job 1 : CodeScan (Bandit)
  # =============================================================
  CodeScan:
    name: Code Security Scan (Bandit)
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------
      # 1️⃣ Checkout repository
      # Récupère le code source pour le scanner
      # -----------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------
      # 2️⃣ Setup Python
      # Configure Python 3.11 pour exécuter Bandit et le script d'affichage
      # -----------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -----------------------------------
      # 3️⃣ Install Bandit et tabulate
      # tabulate servira à afficher les résultats sous forme de tableaux
      # -----------------------------------
      - name: Install Bandit and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit tabulate

      # -----------------------------------
      # 4️⃣ Run Bandit scan
      # Scanne tout le code Python et génère un rapport JSON
      # -----------------------------------
      - name: Run Bandit Scan
        run: |
          REPORT_DIR="reports/bandit/${{ env.TIMESTAMP }}"
          mkdir -p "$REPORT_DIR"
          # Exécute Bandit, continue même si vulnérabilités trouvées
          bandit -r . -f json -o "$REPORT_DIR/bandit-report.json" || true
          echo "✅ Bandit scan finished"

      # -----------------------------------
      # 5️⃣ Display Bandit results in console
      # Affiche les vulnérabilités sous forme de tableau lisible
      # -----------------------------------
      - name: Display Bandit Scan Results
        run: |
          python - << EOF
          import json
          from tabulate import tabulate

          report_file = "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json"
          with open(report_file) as f:
              data = json.load(f)

          vulns = data.get("results", [])
          if not vulns:
              print("✅ No issues found by Bandit")
          else:
              table = []
              for v in vulns:
                  table.append([
                      v.get("filename"),
                      v.get("line_number"),
                      v.get("issue_severity"),
                      v.get("issue_confidence"),
                      v.get("issue_text")
                  ])
              print("\nBandit Scan Results:")
              print(tabulate(table, headers=["File", "Line", "Severity", "Confidence", "Issue"], tablefmt="github"))
          EOF

      # -----------------------------------
      # 6️⃣ Upload Bandit Report
      # Stocke le rapport JSON comme artifact pour téléchargement ultérieur
      # -----------------------------------
      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json
          retention-days: 30
