name: Full Project Automatisation de la gestion des vuln√©rabilit√©s dans les pipelines MLops

on:
  push:
    branches:
      - Develop
  pull_request:
    branches:
      - Develop

jobs:
  # =============================================================
  # Job 1 : CodeScan (Bandit)
  # =============================================================
  CodeScan:
    name: Code Security Scan (Bandit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Bandit and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit tabulate

      - name: Run Bandit Scan
        run: |
          mkdir -p "reports/bandit/${{ env.TIMESTAMP }}"
          bandit -r . -f json -o "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json" || echo "‚ö†Ô∏è Bandit found vulnerabilities, workflow continues."
        continue-on-error: true

      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report-${{ env.TIMESTAMP }}
          path: reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json
          retention-days: 30

  # =============================================================
  # Job 2 : DependencyScan (pip-audit)
  # =============================================================
  DependencyScan:
    name: DependencyScan (pip-audit)
    runs-on: ubuntu-latest
    needs: CodeScan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install project dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pip-audit tabulate

      - name: Run Dependency Scan
        run: |
          mkdir -p "reports/dependency/${{ env.TIMESTAMP }}"
          pip-audit --format=json -o "reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json" || echo "‚ö†Ô∏è Vulnerabilities detected"

      - name: Upload Dependency Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report-${{ env.TIMESTAMP }}
          path: reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json
          retention-days: 30

  # =============================================================
  # Job 3 : ModelScan officiel
  # =============================================================
  ModelScan:
    name: Model Serialization Security Scan
    runs-on: ubuntu-latest
    needs: DependencyScan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Install ModelScan
        run: |
          python -m pip install --upgrade pip
          pip install modelscan==0.8.7

      - name: Create Reports Folder
        run: mkdir -p "reports/models/${{ env.TIMESTAMP }}/official"

      - name: Run ModelScan
        continue-on-error: true
        run: |
          modelscan scan -p model/ --json > "reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json" 2>&1 || true

      - name: Upload ModelScan Report
        uses: actions/upload-artifact@v4
        with:
          name: modelscan-report-${{ env.TIMESTAMP }}
          path: reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json
          retention-days: 30

  # =============================================================
  # Job 4 : ContainerScan (Trivy)
  # =============================================================
  ContainerScan:
    name: ContainerScan (Trivy)
    runs-on: ubuntu-latest
    needs: ModelScan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v0.57.0

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Download Trivy DB
        run: trivy image --download-db-only

      # Scan Dockerfiles
      - name: Scan Dockerfiles
        run: |
          REPORT_DIR="reports/container/${TIMESTAMP}/dockerfiles"
          mkdir -p "$REPORT_DIR"
          find . -name 'Dockerfile*' | while read df; do
            SAFE_NAME=$(echo "$df" | tr '/:' '_')
            trivy config --format json -o "${REPORT_DIR}/scan-${SAFE_NAME}.json" "$df" || echo "‚ö†Ô∏è Scan failed for $df"
          done

      # Scan local Docker images
      - name: Scan local Docker images
        shell: bash
        run: |
          set -euo pipefail
          export REPORT_DIR="reports/container/${{ env.TIMESTAMP }}/local-images"
          mkdir -p "$REPORT_DIR"
          docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>" > images.txt || true

          if [ ! -s images.txt ]; then
            echo "‚ö†Ô∏è No Docker images found, skipping local image scan."
          else
            while read -r image; do
              SAFE_NAME=$(echo "$image" | tr '/:' '_')
              OUTPUT_FILE="${REPORT_DIR}/scan-${SAFE_NAME}.json"
              trivy image --format json --ignore-unfixed --vuln-type os,library \
                --severity CRITICAL,HIGH,MEDIUM,LOW -o "$OUTPUT_FILE" "$image" || echo "‚ö†Ô∏è Scan failed for $image"
            done < images.txt
          fi


      # Upload container scan reports
      - name: Upload ContainerScan Reports
        uses: actions/upload-artifact@v4
        with:
          name: container-scan-${{ env.TIMESTAMP }}
          path: reports/container/${{ env.TIMESTAMP }}/
          retention-days: 30

  # =============================================================
  # Job 5 : CVE Enrichment 
  # =============================================================
  CVEEnrichment:
    name: CVE Enrichment from NVD
    runs-on: ubuntu-latest
    needs: [CodeScan, DependencyScan, ModelScan, ContainerScan]  # Ce job d√©pend des rapports g√©n√©r√©s par les jobs pr√©c√©dents
    steps:

      # 1Ô∏è‚É£ Checkout du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"  # Version de Python pour ex√©cuter le script

      # 3Ô∏è‚É£ Installation des d√©pendances Python n√©cessaires
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests tqdm tabulate  # requests pour API ou lecture JSON, tqdm pour barre de progression, tabulate pour affichage console

      # 4Ô∏è‚É£ T√©l√©chargement du dump JSON officiel NVD
      - name: Download NVD JSON dump
        shell: bash
        run: |
          mkdir -p nvd_db  # Cr√©ation du dossier pour stocker les fichiers NVD
          cd nvd_db

          FILE_YEAR=2025
          FILE_NAME="nvdcve-1.1-${FILE_YEAR}.json.gz"
          URL="https://nvd.nist.gov/feeds/json/cve/1.1/${FILE_NAME}"

          echo "üîÑ Downloading NVD JSON dump for ${FILE_YEAR}..."
          curl -L -o "$FILE_NAME" "$URL"  # T√©l√©chargement du fichier avec suivi des redirections

          # V√©rifier le type du fichier t√©l√©charg√©
          FILE_TYPE=$(file "$FILE_NAME")
          echo "Downloaded file type: $FILE_TYPE"

          if [[ "$FILE_TYPE" == *gzip* ]]; then
            gzip -dk "$FILE_NAME"  # D√©compression si gzip
            echo "‚úÖ Decompressed $FILE_NAME successfully"
          else
            echo "‚ö†Ô∏è Warning: downloaded file is not gzip, using as is"
            mv "$FILE_NAME" "nvdcve-1.1-${FILE_YEAR}.json"  # Renommage si le fichier n‚Äôest pas compress√©
          fi

      # 5Ô∏è‚É£ Ex√©cution du script Python pour enrichir les CVE
      - name: Run CVE Enrichment
        shell: bash
        run: |
          echo "üîç Enriching CVEs from reports..."
          python scripts/cve_enrichment.py \
            --nvd-db "nvd_db/nvdcve-1.1-2025.json" \  # Chemin du dump NVD
            --bandit-report "reports/bandit/${{ env.TIMESTAMP }}/bandit-report.json" \  # Rapport Bandit
            --dependency-report "reports/dependency/${{ env.TIMESTAMP }}/dependency-report.json" \  # Rapport pip-audit
            --modelscan-report "reports/models/${{ env.TIMESTAMP }}/official/modelscan-report.json" \  # Rapport ModelScan
            --container-reports "reports/container/${{ env.TIMESTAMP }}/**/*.json" \  # Tous les rapports Trivy
            --output "reports/cve_enrichment/${{ env.TIMESTAMP }}/enriched_cves.json"  # Fichier final enrichi

      # 6Ô∏è‚É£ Upload des rapports enrichis comme artefact GitHub
      - name: Upload Enriched CVE Reports
        uses: actions/upload-artifact@v4
        with:
          name: enriched-cve-report-${{ env.TIMESTAMP }}  # Nom de l‚Äôartefact
          path: reports/cve_enrichment/${{ env.TIMESTAMP }}/enriched_cves.json  # Chemin du fichier √† uploader
          retention-days: 30  # Dur√©e de conservation de l‚Äôartefact

